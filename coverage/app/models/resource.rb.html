<html>
  <head>
    <title>app/models/resource.rb</title>
    
    <link href="../../report.css?0.10276205734454791" media="screen" rel="stylesheet" type="text/css" />
    <script src='../../jquery.js?0.67499957681279'></script>
    <script>
      $(function() {

        $('#toggle_test_file').click(function(e) {
          e.preventDefault();
          if ($('#main_file').hasClass('side_by_side')) {
            $('#main_file').removeClass('side_by_side');
          } else {
            $('#main_file').addClass('side_by_side');
          }
        
          $('#test_file').toggle();
        });

        $('#test_file').hide();
        
        function cleanString(str) {
          return $.trim(str.replace(/<[^(<|>)]+>/gi, ''));
        }
        
        $('.line_number').hover(function() {
          $(this).attr('title', 'Line: ' + cleanString($(this).html()));
        });
        
        $('.hit_number').hover(function() {
          $(this).attr('title', 'Execution Count: ' + cleanString($(this).html()));
        });
        
        $('.code_line').hover(function() {
          $(this).attr('title', cleanString($(this).html()));
        });
        
      });
    </script>
  </head>
  <body>
    <h1><a href="../../index.html">Coverage Report</a></h1>
    
    <table cellpadding='0' cellspacing='1'>
      <tr class='header'>
        <th>File</th>
        <th>Lines</th>
        <th>Lines Of Code</th>
        <th>Untested Lines of Code</th>
        <th>Tested %</th>
      </tr>
      <tr valign='top'>
        <td>
          app/models/resource.rb
          
        </td>
        <td>372</td>
        <td>168</td>
        <td>117</td>
        <td>30.4%</td>
      </tr>
    </table>

    <div>&nbsp;</div>
    
    <table cellpadding='0' cellspacing='1'>
      <tr>
        <th>Legend</th>
      </tr>
      <tr>
        <td class='hit'>This line was executed.</td>
      </tr>
      <tr>
        <td class='miss'>This line was not executed!</td>
      </tr>
      <tr>
        <td class='never'>This line doesn't matter.</td>
      </tr>
    </table>
    
    <div>&nbsp;</div>

    <div id='content'>
      <div id='main_file'>
        <table id='main'>
          
            <tr class="never" "">
              <td class='line_number'>1</td>
              <td class='code_line'>
                <pre># -*- encoding : utf-8 -*-</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>2</td>
              <td class='code_line'>
                <pre>module Resource</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>3</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>4</td>
              <td class='code_line'>
                <pre>  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>5</td>
              <td class='code_line'>
                <pre>  def self.included(base)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>6</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>7</td>
              <td class='code_line'>
                <pre>   # TODO observe bulk changes and reindex once</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>8</td>
              <td class='code_line'>
                <pre>    base.has_many :meta_data, :as => :resource, :dependent => :destroy do #working here#7 :include => :meta_key</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>9</td>
              <td class='code_line'>
                <pre>      def get(key_id)</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>10</td>
              <td class='code_line'>
                <pre>        # unless ... and !!v.match(/\A[+-]?\d+\Z/) # TODO path to String#is_numeric? method</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>11</td>
              <td class='code_line'>
                <pre>        #TODO: handle the case when key_id is a MetaKey object</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>12</td>
              <td class='code_line'>
                <pre>        key_id = MetaKey.find_by_label(key_id.downcase).id unless key_id.is_a?(Fixnum)</pre>
              </td>
              <td class='hit_number'>1</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>13</td>
              <td class='code_line'>
                <pre>        r = where(:meta_key_id => key_id).first # OPTIMIZE prevent find if is_dynamic meta_key</pre>
              </td>
              <td class='hit_number'>1</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>14</td>
              <td class='code_line'>
                <pre>        r ||= build(:meta_key_id => key_id)</pre>
              </td>
              <td class='hit_number'>1</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>15</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>16</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>17</td>
              <td class='code_line'>
                <pre>      def get_value_for(key_id)</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>18</td>
              <td class='code_line'>
                <pre>        get(key_id).to_s</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>19</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>20</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>21</td>
              <td class='code_line'>
                <pre>      #def with_labels</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>22</td>
              <td class='code_line'>
                <pre>      #  h = {}</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>23</td>
              <td class='code_line'>
                <pre>      #  all.each do |meta_datum|</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>24</td>
              <td class='code_line'>
                <pre>      #    next unless meta_datum.meta_key # FIXME inconsistency: there are meta_data referencing to not existing meta_key_ids [131, 135]</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>25</td>
              <td class='code_line'>
                <pre>      #    h[meta_datum.meta_key.label] = meta_datum.to_s</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>26</td>
              <td class='code_line'>
                <pre>      #  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>27</td>
              <td class='code_line'>
                <pre>      #  h</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>28</td>
              <td class='code_line'>
                <pre>      #end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>29</td>
              <td class='code_line'>
                <pre>      def concatenated</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>30</td>
              <td class='code_line'>
                <pre>        all.map(&:to_s).join('; ')</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>31</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>32</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>33</td>
              <td class='code_line'>
                <pre>    base.accepts_nested_attributes_for :meta_data, :allow_destroy => true,</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>34</td>
              <td class='code_line'>
                <pre>                                               :reject_if => proc { |attributes| attributes['value'].blank? and attributes['_destroy'].blank? }</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>35</td>
              <td class='code_line'>
                <pre>                                               # NOTE the check on _destroy should be automatic, check Rails > 3.0.3</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>36</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>37</td>
              <td class='code_line'>
                <pre>#temp#</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>38</td>
              <td class='code_line'>
                <pre>#    # enforce meta_key uniqueness updating existing meta_datum</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>39</td>
              <td class='code_line'>
                <pre>#    # also useful for bulk meta_data updates such as Copyright, Organizer forms,...</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>40</td>
              <td class='code_line'>
                <pre>#    base.before_validation(:on => :update) do |record|</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>41</td>
              <td class='code_line'>
                <pre>#      new_meta_data = record.meta_data.select{|md| md.new_record? }</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>42</td>
              <td class='code_line'>
                <pre>#      new_meta_data.each do |new_md|</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>43</td>
              <td class='code_line'>
                <pre>#        old_md = record.meta_data.detect{|md| !md.new_record? and md.meta_key_id == new_md.meta_key_id }</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>44</td>
              <td class='code_line'>
                <pre>#        if old_md</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>45</td>
              <td class='code_line'>
                <pre>#          old_md.value = new_md.value</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>46</td>
              <td class='code_line'>
                <pre>#          record.meta_data.delete(new_md)</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>47</td>
              <td class='code_line'>
                <pre>#        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>48</td>
              <td class='code_line'>
                <pre>#      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>49</td>
              <td class='code_line'>
                <pre>#    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>50</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>51</td>
              <td class='code_line'>
                <pre>    base.has_many  :permissions, :as => :resource, :dependent => :destroy</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>52</td>
              <td class='code_line'>
                <pre>    base.before_validation { permissions.delete_if {|p| p.new_record? and p.subject.nil? and p.invalid? } } #2904# OPTIMIZE</pre>
              </td>
              <td class='hit_number'>41</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>53</td>
              <td class='code_line'>
                <pre>    base.after_create :generate_permissions</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>54</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>55</td>
              <td class='code_line'>
                <pre>    base.has_many  :edit_sessions, :as => :resource, :dependent => :destroy, :readonly => true</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>56</td>
              <td class='code_line'>
                <pre>    base.has_many  :editors, :through => :edit_sessions, :source => :user do</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>57</td>
              <td class='code_line'>
                <pre>      def latest</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>58</td>
              <td class='code_line'>
                <pre>        first</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>59</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>60</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>61</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>62</td>
              <td class='code_line'>
                <pre>    base.validates_presence_of :user, :if => Proc.new { |record| record.respond_to?(:user_id) }</pre>
              </td>
              <td class='hit_number'>41</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>63</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>64</td>
              <td class='code_line'>
                <pre>    def update_attributes_with_pre_validation(attributes, current_user = nil)</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>65</td>
              <td class='code_line'>
                <pre>      # we need to deep copy the attributes for batch edit (multiple resources)</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>66</td>
              <td class='code_line'>
                <pre>      dup_attributes = Marshal.load(Marshal.dump(attributes))</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>67</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>68</td>
              <td class='code_line'>
                <pre>      # To avoid overriding at batch update: remove from attribute hash if :keep_original_value and value is blank</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>69</td>
              <td class='code_line'>
                <pre>      dup_attributes[:meta_data_attributes].delete_if { |key, attr| attr[:keep_original_value] and attr[:value].blank? }</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>70</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>71</td>
              <td class='code_line'>
                <pre>      dup_attributes[:meta_data_attributes].each_pair do |key, attr|</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>72</td>
              <td class='code_line'>
                <pre>        if attr[:value].is_a? Array and attr[:value].all? {|x| x.blank? }</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>73</td>
              <td class='code_line'>
                <pre>          attr[:value] = nil</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>74</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>75</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>76</td>
              <td class='code_line'>
                <pre>        # find existing meta_datum, if it exists</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>77</td>
              <td class='code_line'>
                <pre>        if attr[:id].blank? and (md = meta_data.where(:meta_key_id => attr[:meta_key_id]).first)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>78</td>
              <td class='code_line'>
                <pre>          attr[:id] = md.id</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>79</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>80</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>81</td>
              <td class='code_line'>
                <pre>        # get rid of meta_datum if value is blank</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>82</td>
              <td class='code_line'>
                <pre>        if !attr[:id].blank? and attr[:value].blank?</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>83</td>
              <td class='code_line'>
                <pre>          attr[:_destroy] = true</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>84</td>
              <td class='code_line'>
                <pre>          #old# attr[:value] = "." # NOTE bypass the validation</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>85</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>86</td>
              <td class='code_line'>
                <pre>      end if dup_attributes[:meta_data_attributes]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>87</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>88</td>
              <td class='code_line'>
                <pre>      self.editors << current_user if current_user # OPTIMIZE group by user ??</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>89</td>
              <td class='code_line'>
                <pre>      self.updated_at = Time.now # OPTIMIZE touch</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>90</td>
              <td class='code_line'>
                <pre>      update_attributes_without_pre_validation(dup_attributes)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>91</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>92</td>
              <td class='code_line'>
                <pre>    base.alias_method_chain :update_attributes, :pre_validation</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>93</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>94</td>
              <td class='code_line'>
                <pre>    base.has_one :full_text, :as => :resource, :dependent => :destroy</pre>
              </td>
              <td class='hit_number'>4</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>95</td>
              <td class='code_line'>
                <pre>    base.after_save { reindex } # OPTIMIZE</pre>
              </td>
              <td class='hit_number'>41</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>96</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>97</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>98</td>
              <td class='code_line'>
                <pre>  def default_permission</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>99</td>
              <td class='code_line'>
                <pre>    Permission.resource_default(self)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>100</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>101</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>102</td>
              <td class='code_line'>
                <pre>  # returns the meta_data for a particular resource, so that it can written into a media file that is to be exported.</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>103</td>
              <td class='code_line'>
                <pre>  # NB: this is exiftool specific at present, but can be refactored to take account of other tools if necessary.</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>104</td>
              <td class='code_line'>
                <pre>  # NB: In this case the 'export' in 'get_data_for_export' also means 'download' </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>105</td>
              <td class='code_line'>
                <pre>  #     (since we write meta-data to the file anyway regardless of if we do a download or an export)</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>106</td>
              <td class='code_line'>
                <pre>  def to_metadata_tags</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>107</td>
              <td class='code_line'>
                <pre>    MetaContext.io_interface.meta_key_definitions.collect do |definition|</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>108</td>
              <td class='code_line'>
                <pre>      # OPTIMIZE</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>109</td>
              <td class='code_line'>
                <pre>      value = if definition.meta_key.object_type == "Meta::Date"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>110</td>
              <td class='code_line'>
                <pre>                meta_data.get(definition.meta_key_id).to_s</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>111</td>
              <td class='code_line'>
                <pre>              else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>112</td>
              <td class='code_line'>
                <pre>                meta_data.get(definition.meta_key_id).deserialized_value</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>113</td>
              <td class='code_line'>
                <pre>              end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>114</td>
              <td class='code_line'>
                <pre>      </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>115</td>
              <td class='code_line'>
                <pre>      definition.key_map.split(',').collect do |km|</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>116</td>
              <td class='code_line'>
                <pre>        km.strip!</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>117</td>
              <td class='code_line'>
                <pre>        case definition.key_map_type</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>118</td>
              <td class='code_line'>
                <pre>          when "Array"</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>119</td>
              <td class='code_line'>
                <pre>            vo = ["-#{km}= "]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>120</td>
              <td class='code_line'>
                <pre>            vo += value.collect {|m| "-#{km}='#{(m.respond_to?(:strip) ? m.strip : m)}'" } if value</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>121</td>
              <td class='code_line'>
                <pre>            vo</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>122</td>
              <td class='code_line'>
                <pre>          else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>123</td>
              <td class='code_line'>
                <pre>            "-#{km}='#{value}'"          </pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>124</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>125</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>126</td>
              <td class='code_line'>
                <pre>      </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>127</td>
              <td class='code_line'>
                <pre>    end.join(" ")</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>128</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>129</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>130</td>
              <td class='code_line'>
                <pre>  # Instance method to update a copy (referenced by path) of a media file with the meta_data tags provided</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>131</td>
              <td class='code_line'>
                <pre>  # args: blank_all_tags = flag indicating whether we clean all the tags from the file, or update the tags in the file</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>132</td>
              <td class='code_line'>
                <pre>  # returns: the path and filename of the updated copy or nil (if the copy failed)</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>133</td>
              <td class='code_line'>
                <pre>  def updated_resource_file(blank_all_tags = false, size = nil)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>134</td>
              <td class='code_line'>
                <pre>    begin</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>135</td>
              <td class='code_line'>
                <pre>      source_filename = if size</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>136</td>
              <td class='code_line'>
                <pre>        media_file.get_preview(size).full_path</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>137</td>
              <td class='code_line'>
                <pre>      else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>138</td>
              <td class='code_line'>
                <pre>        media_file.file_storage_location</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>139</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>140</td>
              <td class='code_line'>
                <pre>      FileUtils.cp( source_filename, DOWNLOAD_STORAGE_DIR )</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>141</td>
              <td class='code_line'>
                <pre>      # remember we want to handle the following:</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>142</td>
              <td class='code_line'>
                <pre>      # include all madek tags in file</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>143</td>
              <td class='code_line'>
                <pre>      # remove all (ok, as many as we can) tags from the file.</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>144</td>
              <td class='code_line'>
                <pre>      cleaner_tags = (blank_all_tags ? "-All= " : "-IPTC:All= ") + "-XMP-madek:All= -IFD0:Artist= -IFD0:Copyright= -IFD0:Software= " # because we do want to remove IPTC tags, regardless</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>145</td>
              <td class='code_line'>
                <pre>      tags = cleaner_tags + (blank_all_tags ? "" : to_metadata_tags)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>146</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>147</td>
              <td class='code_line'>
                <pre>      path = File.join(DOWNLOAD_STORAGE_DIR, File.basename(source_filename))</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>148</td>
              <td class='code_line'>
                <pre>      # TODO - robustification</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>149</td>
              <td class='code_line'>
                <pre>      generate_exiftool_config if MetaContext.io_interface.meta_key_definitions.maximum("updated_at").to_i > File.stat(EXIFTOOL_CONFIG).mtime.to_i</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>150</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>151</td>
              <td class='code_line'>
                <pre>      resout = `#{EXIFTOOL_PATH} #{tags} "#{path}"`</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>152</td>
              <td class='code_line'>
                <pre>      FileUtils.rm("#{path}_original") if resout.include?("1 image files updated") # Exiftool backs up the original before editing. We don't need the backup.</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>153</td>
              <td class='code_line'>
                <pre>      return path.to_s</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>154</td>
              <td class='code_line'>
                <pre>    rescue </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>155</td>
              <td class='code_line'>
                <pre>      # "No such file or directory" ?</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>156</td>
              <td class='code_line'>
                <pre>      logger.error "MediaFile#update_file_metadata, copy failed with #{$!}"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>157</td>
              <td class='code_line'>
                <pre>      return nil</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>158</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>159</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>160</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>161</td>
              <td class='code_line'>
                <pre>  # ad-hoc method that generates a new exiftool config file, when it is sensed that there are new keys/key_defs that should be saved in a file</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>162</td>
              <td class='code_line'>
                <pre>  # using the XMP-madek metadata namespace.</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>163</td>
              <td class='code_line'>
                <pre>  # TODO refactor the use of exiftool, so that for each media file/entry it is only called once, </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>164</td>
              <td class='code_line'>
                <pre>  # entrys' contents cached, and obj/subj meta-data extracted as necessary  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>165</td>
              <td class='code_line'>
                <pre>    def generate_exiftool_config</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>166</td>
              <td class='code_line'>
                <pre>      exiftool_keys = MetaContext.io_interface.meta_key_definitions.collect {|e| "#{e.key_map.split(":").last} => {#{e.key_map_type == "Array" ? " List => 'Bag'" : nil} },"}</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>167</td>
              <td class='code_line'>
                <pre>  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>168</td>
              <td class='code_line'>
                <pre>      skels = Dir.glob("#{METADATA_CONFIG_DIR}/ExifTool_config.skeleton.*")</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>169</td>
              <td class='code_line'>
                <pre>  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>170</td>
              <td class='code_line'>
                <pre>      exif_conf = File.open(EXIFTOOL_CONFIG, 'w')</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>171</td>
              <td class='code_line'>
                <pre>      exif_conf.puts IO.read(skels.first)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>172</td>
              <td class='code_line'>
                <pre>      exiftool_keys.sort.each do |k|</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>173</td>
              <td class='code_line'>
                <pre>        exif_conf.puts "\t#{k}\n"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>174</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>175</td>
              <td class='code_line'>
                <pre>      exif_conf.puts IO.read(skels.last)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>176</td>
              <td class='code_line'>
                <pre>      exif_conf.close</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>177</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>178</td>
              <td class='code_line'>
                <pre>    </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>179</td>
              <td class='code_line'>
                <pre>    # TODO merge to as_json</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>180</td>
              <td class='code_line'>
                <pre>    # NEW and experimental for batch processes </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>181</td>
              <td class='code_line'>
                <pre>    def get_basic_info(current_user, extended_keys = [], with_thumb = false)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>182</td>
              <td class='code_line'>
                <pre>      core_keys = ["title", "author"]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>183</td>
              <td class='code_line'>
                <pre>      core_info = Hash.new</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>184</td>
              <td class='code_line'>
                <pre>      </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>185</td>
              <td class='code_line'>
                <pre>      (core_keys + extended_keys).each do |key|</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>186</td>
              <td class='code_line'>
                <pre>        core_info[key.gsub(' ', '_')] = meta_data.get_value_for(key)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>187</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>188</td>
              <td class='code_line'>
                <pre>      if with_thumb</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>189</td>
              <td class='code_line'>
                <pre>        mf = if self.is_a?(Media::Set)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>190</td>
              <td class='code_line'>
                <pre>          MediaResource.accessible_by_user(current_user).media_entries.by_media_set(self).first.try(:media_file)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>191</td>
              <td class='code_line'>
                <pre>        else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>192</td>
              <td class='code_line'>
                <pre>          self.media_file</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>193</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>194</td>
              <td class='code_line'>
                <pre>        core_info["thumb_base64"] = mf.thumb_base64(:small_125) if mf</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>195</td>
              <td class='code_line'>
                <pre>      else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>196</td>
              <td class='code_line'>
                <pre>        #1+n http-requests#</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>197</td>
              <td class='code_line'>
                <pre>        me = if self.is_a?(Media::Set)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>198</td>
              <td class='code_line'>
                <pre>          MediaResource.accessible_by_user(current_user).media_entries.by_media_set(self).first</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>199</td>
              <td class='code_line'>
                <pre>        else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>200</td>
              <td class='code_line'>
                <pre>          self</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>201</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>202</td>
              <td class='code_line'>
                <pre>        core_info["thumb_base64"] = "/media_entries/%d/image?size=small_125" % me.id if me</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>203</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>204</td>
              <td class='code_line'>
                <pre>      core_info</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>205</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>206</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>207</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>208</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>209</td>
              <td class='code_line'>
                <pre>  # OPTIMIZE</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>210</td>
              <td class='code_line'>
                <pre>#  scope :without_meta_data, :select => "media_entries.*",</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>211</td>
              <td class='code_line'>
                <pre>#                                  #:joins => "LEFT JOIN items ON items.model_id = models.id",</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>212</td>
              <td class='code_line'>
                <pre>#                                  #:conditions => ['items.model_id IS NULL']</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>213</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>214</td>
              <td class='code_line'>
                <pre>  def title</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>215</td>
              <td class='code_line'>
                <pre>    t = meta_data.get_value_for("title")</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>216</td>
              <td class='code_line'>
                <pre>    t = "Ohne Titel" if t.blank?</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>217</td>
              <td class='code_line'>
                <pre>    t</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>218</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>219</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>220</td>
              <td class='code_line'>
                <pre>  def title_and_user</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>221</td>
              <td class='code_line'>
                <pre>    s = ""</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>222</td>
              <td class='code_line'>
                <pre>    s += "#{title} (#{user})"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>223</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>224</td>
              <td class='code_line'>
                <pre>  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>225</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>226</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>227</td>
              <td class='code_line'>
                <pre>  def as_json(options={})</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>228</td>
              <td class='code_line'>
                <pre>    with_thumb = options[:with_thumb]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>229</td>
              <td class='code_line'>
                <pre>    more_json = {}</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>230</td>
              <td class='code_line'>
                <pre>    </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>231</td>
              <td class='code_line'>
                <pre>    if user = options[:user]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>232</td>
              <td class='code_line'>
                <pre>      #TODO Dont do this behaviour on default</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>233</td>
              <td class='code_line'>
                <pre>      flags = { :is_private => acl?(:view, :only, user),</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>234</td>
              <td class='code_line'>
                <pre>                :is_public => acl?(:view, :all),</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>235</td>
              <td class='code_line'>
                <pre>                :is_editable => Permission.authorized?(user, :edit, self),</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>236</td>
              <td class='code_line'>
                <pre>                :is_manageable => Permission.authorized?(user, :manage, self) }</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>237</td>
              <td class='code_line'>
                <pre>      more_json.merge! flags         </pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>238</td>
              <td class='code_line'>
                <pre>      more_json.merge!(self.get_basic_info(user, [], with_thumb))</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>239</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>240</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>241</td>
              <td class='code_line'>
                <pre>    default_options = {:only => :id}</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>242</td>
              <td class='code_line'>
                <pre>    json = super(default_options.deep_merge(options))</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>243</td>
              <td class='code_line'>
                <pre>    </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>244</td>
              <td class='code_line'>
                <pre>    # add relationships for a given parent</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>245</td>
              <td class='code_line'>
                <pre>    </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>246</td>
              <td class='code_line'>
                <pre>    json.merge(more_json)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>247</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>248</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>249</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>250</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>251</td>
              <td class='code_line'>
                <pre>  def self.to_tms_doc(resources, context = MetaContext.tms)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>252</td>
              <td class='code_line'>
                <pre>    xml = Builder::XmlMarkup.new</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>253</td>
              <td class='code_line'>
                <pre>    xml.instruct!</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>254</td>
              <td class='code_line'>
                <pre>    xml.madek(:version => RELEASE_VERSION) do</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>255</td>
              <td class='code_line'>
                <pre>      Array(resources).each do |resource|</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>256</td>
              <td class='code_line'>
                <pre>        resource.to_tms(xml, context)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>257</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>258</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>259</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>260</td>
              <td class='code_line'>
                <pre>  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>261</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>262</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>263</td>
              <td class='code_line'>
                <pre>  def reindex</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>264</td>
              <td class='code_line'>
                <pre>    ft = full_text || build_full_text</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>265</td>
              <td class='code_line'>
                <pre>    new_text = meta_data.concatenated</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>266</td>
              <td class='code_line'>
                <pre>    [:user].each do |method|</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>267</td>
              <td class='code_line'>
                <pre>      new_text << " #{send(method)}" if respond_to?(method)</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>268</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>269</td>
              <td class='code_line'>
                <pre>    ft.update_attributes(:text => new_text)</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>270</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>271</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>272</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>273</td>
              <td class='code_line'>
                <pre># TODO cache methods results</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>274</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>275</td>
              <td class='code_line'>
                <pre>  def meta_data_for_context(context = MetaContext.core, build_if_not_exists = true)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>276</td>
              <td class='code_line'>
                <pre>    @meta_data_for_context ||= {}</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>277</td>
              <td class='code_line'>
                <pre>    # OPTIMIZE cache for build_if_not_exists</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>278</td>
              <td class='code_line'>
                <pre>    #unless @meta_data_for_context[context.id]</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>279</td>
              <td class='code_line'>
                <pre>      @meta_data_for_context[context.id] = []</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>280</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>281</td>
              <td class='code_line'>
                <pre>      context.meta_keys.each do |key|</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>282</td>
              <td class='code_line'>
                <pre>        md = key.meta_data.scoped_by_resource_type_and_resource_id(self.class.base_class.name, self.id).first  # OPTIMIZE eager loading</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>283</td>
              <td class='code_line'>
                <pre>        if md</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>284</td>
              <td class='code_line'>
                <pre>          @meta_data_for_context[context.id] << md</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>285</td>
              <td class='code_line'>
                <pre>        elsif build_if_not_exists or key.is_dynamic?</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>286</td>
              <td class='code_line'>
                <pre>          @meta_data_for_context[context.id] << meta_data.build(:meta_key => key)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>287</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>288</td>
              <td class='code_line'>
                <pre>      end if context</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>289</td>
              <td class='code_line'>
                <pre>    #end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>290</td>
              <td class='code_line'>
                <pre>    return @meta_data_for_context[context.id]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>291</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>292</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>293</td>
              <td class='code_line'>
                <pre>  def context_warnings(context = MetaContext.core)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>294</td>
              <td class='code_line'>
                <pre>    @context_warnings ||= {}</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>295</td>
              <td class='code_line'>
                <pre>    unless @context_warnings[context.id]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>296</td>
              <td class='code_line'>
                <pre>      @context_warnings[context.id] = {}</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>297</td>
              <td class='code_line'>
                <pre>      meta_data_for_context(context).each do |meta_datum|</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>298</td>
              <td class='code_line'>
                <pre>        w = meta_datum.context_warnings(context)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>299</td>
              <td class='code_line'>
                <pre>        unless w.blank?</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>300</td>
              <td class='code_line'>
                <pre>          @context_warnings[context.id][meta_datum.meta_key.label] ||= []</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>301</td>
              <td class='code_line'>
                <pre>          @context_warnings[context.id][meta_datum.meta_key.label] << w</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>302</td>
              <td class='code_line'>
                <pre>        end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>303</td>
              <td class='code_line'>
                <pre>      end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>304</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>305</td>
              <td class='code_line'>
                <pre>    return @context_warnings[context.id]</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>306</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>307</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>308</td>
              <td class='code_line'>
                <pre>  def context_valid?(context = MetaContext.core)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>309</td>
              <td class='code_line'>
                <pre>    meta_data_for_context(context).all? {|meta_datum| meta_datum.context_valid?(context) }</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>310</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>311</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>312</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>313</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>314</td>
              <td class='code_line'>
                <pre>  def media_type</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>315</td>
              <td class='code_line'>
                <pre>    if respond_to?(:media_file)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>316</td>
              <td class='code_line'>
                <pre>      case media_file.content_type</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>317</td>
              <td class='code_line'>
                <pre>        when /video/ then </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>318</td>
              <td class='code_line'>
                <pre>          "Video"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>319</td>
              <td class='code_line'>
                <pre>        when /audio/ then</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>320</td>
              <td class='code_line'>
                <pre>          "Audio"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>321</td>
              <td class='code_line'>
                <pre>        when /image/ then</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>322</td>
              <td class='code_line'>
                <pre>          "Image"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>323</td>
              <td class='code_line'>
                <pre>        else </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>324</td>
              <td class='code_line'>
                <pre>          "Doc"</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>325</td>
              <td class='code_line'>
                <pre>      end </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>326</td>
              <td class='code_line'>
                <pre>    else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>327</td>
              <td class='code_line'>
                <pre>      self.type.gsub(/Media::/, '')</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>328</td>
              <td class='code_line'>
                <pre>    end    </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>329</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>330</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>331</td>
              <td class='code_line'>
                <pre>########################################################</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>332</td>
              <td class='code_line'>
                <pre># ACL</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>333</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>334</td>
              <td class='code_line'>
                <pre>  def acl?(action, scope, subject = nil)</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>335</td>
              <td class='code_line'>
                <pre>    case scope</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>336</td>
              <td class='code_line'>
                <pre>      when :all</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>337</td>
              <td class='code_line'>
                <pre>        # TODO ?? use :permissions association</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>338</td>
              <td class='code_line'>
                <pre>        Permission.authorized?(nil, action, self)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>339</td>
              <td class='code_line'>
                <pre>      when :only</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>340</td>
              <td class='code_line'>
                <pre>        Permission.resource_viewable_only_by_user?(self, subject)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>341</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>342</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>343</td>
              <td class='code_line'>
                <pre>  </pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>344</td>
              <td class='code_line'>
                <pre>  def managers</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>345</td>
              <td class='code_line'>
                <pre>    i = Permission::ACTIONS.index(:manage)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>346</td>
              <td class='code_line'>
                <pre>    return nil unless i</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>347</td>
              <td class='code_line'>
                <pre>    j = 2 ** i</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>348</td>
              <td class='code_line'>
                <pre>    permissions.where("#{SQLHelper.bitwise_is 'action_bits',j} AND #{SQLHelper.bitwise_is 'action_mask',j}").map(&:subject)</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>349</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>350</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>351</td>
              <td class='code_line'>
                <pre>private</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>352</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>353</td>
              <td class='code_line'>
                <pre>  def generate_permissions</pre>
              </td>
              <td class='hit_number'>2</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>354</td>
              <td class='code_line'>
                <pre>    # OPTIMIZE</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>355</td>
              <td class='code_line'>
                <pre>    unless self.class == Snapshot</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>356</td>
              <td class='code_line'>
                <pre>      subject = self.user</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>357</td>
              <td class='code_line'>
                <pre>    else</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>358</td>
              <td class='code_line'>
                <pre>      #1504#</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>359</td>
              <td class='code_line'>
                <pre>      h = media_entry.default_permission.actions</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>360</td>
              <td class='code_line'>
                <pre>      permissions.build(:subject => nil).set_actions(h) unless h.blank?</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="miss" data-hits='#{cov}'"">
              <td class='line_number'>361</td>
              <td class='code_line'>
                <pre>      subject = Group.find_or_create_by_name("MIZ-Archiv") # Group.scoped_by_name("MIZ-Archiv").first</pre>
              </td>
              <td class='hit_number'>0</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>362</td>
              <td class='code_line'>
                <pre>    end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>363</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>364</td>
              <td class='code_line'>
                <pre>    # TODO validates presence of the owner's permissions?</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>365</td>
              <td class='code_line'>
                <pre>    if subject</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>366</td>
              <td class='code_line'>
                <pre>     user_default_permissions = {:view => true, :edit => true, :manage => true}</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>367</td>
              <td class='code_line'>
                <pre>     user_default_permissions[:hi_res] = true if self.class == MediaEntry</pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="hit" data-hits='#{cov}'"">
              <td class='line_number'>368</td>
              <td class='code_line'>
                <pre>     permissions.build(:subject => subject).set_actions(user_default_permissions)  </pre>
              </td>
              <td class='hit_number'>37</td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>369</td>
              <td class='code_line'>
                <pre>    end # OPTIMIZE</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>370</td>
              <td class='code_line'>
                <pre>  end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>371</td>
              <td class='code_line'>
                <pre></pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
            <tr class="never" "">
              <td class='line_number'>372</td>
              <td class='code_line'>
                <pre>end</pre>
              </td>
              <td class='hit_number'></td>
            </tr>
          
        </table>
      </div>
      
    </div>
    
    <p>Generated on: 2012-01-13 12:28:34 +0100</p>
  </body>
</html>