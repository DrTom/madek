%section#content_head
  .container_12.clearfix
    #page_head_edit
      %div.page_title_left
        %img{:src => "/themes/madek11/images/icons/icon_permission.png"}
        =_("Zugriffsberechtigungen editieren")
      .clear
      %hr
      .task_bar.clearfix
        %ul
          %li
            %h4= "#{@media_entries.size} Medieneinträge ausgewählt"
        #selected_items_edit
          #list_as_thumbnails
            hello from thumbnails
            
:plain    
  <script type="text/x-jquery-tmpl" id="thumbnail_view">
      <div class="thumb_box">
        <a href="/media_entries/${id}">
          <img src="${thumb_base64}">
        </a>
        <!-- <p>
          <span class="item_title">${title}</span>
          <span class="item_author">${author}</span>
        </p> -->
      </div>
  </script>

.container_12.clearfix  
  %section#content_body2.clearfix
    .grid_9.alpha
      .page_title_left 
        %span Aktuelle Zugriffsberechtigungen für alle ausgewählten Medieneinträge
      .clear
      %hr
      
      - form_tag update_multiple_permissions_media_entries_path, :method => :put do
        = hidden_field_tag :media_entry_ids, @media_entries.map(&:id).join(',')
        
        %table.permissions
          %tbody
            %tr
              %th
                Namen:
              %th{:colspan => 2}
                Berechtigungen:
              %th
            %tr
              %td
                %strong Personen
              %td
                Sehen
              %td
                Editieren
              %td
                Download volle Auflösung
          %tbody#user_permissions
            ///
            ///
          %tbody
            %tr.adder
              %td{:colspan => 5}
                Person hinzufügen:
                %input#new_user
            %tr.adder
              %td{:colspan => 5}
                %p.hint
                  Es können nur Personen ausgewählt werden, die sich schon einmal im Medienarchiv eingeloggt haben.
          %tbody
            %tr
              %td
                %strong Gruppen
              %td
                Sehen
              %td
                Editieren
              %td
                Download volle Auflösung
          %tbody#group_permissions
            ///
            ///
          %tbody
            %tr.adder
              %td{:colspan => 5}
                Gruppe hinzufügen:
                %input#new_group
          %tbody
            %tr
              %td
                %strong Allgemein
              %td
                Sehen
              %td
                Editieren
              %td
                Download volle Auflösung
          %tbody#anyone_permissions
            ///
        %br
        %div{:class => "save_buttons"}
          = link_to _("Abbrechen"), @media_set, :class => "buttons"    
          = submit_tag _("Speichern")

    .grid_2.omega
      #legend
        %h3 Legende
        %p{:style => "background: red url(/themes/madek11/images/stripe_1.png); height: 30px ; border: 1px solid #ccc;"} 
        %p.info Unterschiedliche Berechtigungen vorhanden. Achtung: Bestehende Werte werden überschrieben!
    .clear

%script{:type => "text/x-jquery-tmpl", :id => "new_permission"}
  %tr
    %td
      ${name}    
    %td{:style => "{{if (view == 'mixed')}}background: url(/themes/madek11/images/stripe_1.png){{/if}}"}
      %input{:name => "{{if (type == 'nil')}}subject[${type}][view]{{else}}subject[${type}][${id}][view]{{/if}}", :type => "hidden", :value => "false"}
      <input name="{{if (type == 'nil')}}subject[${type}][view]{{else}}subject[${type}][${id}][view]{{/if}}" type="checkbox" value="true" {{if view}}checked="checked"{{/if}}>
    %td{:style => "{{if (edit == 'mixed')}}background: url(/themes/madek11/images/stripe_1.png){{/if}}"}
      %input{:name => "{{if (type == 'nil')}}subject[${type}][edit]{{else}}subject[${type}][${id}][edit]{{/if}}", :type => "hidden", :value => "false"}
      <input name="{{if (type == 'nil')}}subject[${type}][edit]{{else}}subject[${type}][${id}][edit]{{/if}}" type="checkbox" value="true" {{if edit}}checked="checked"{{/if}}>
    %td{:style => "{{if (hi_res == 'mixed')}}background: url(/themes/madek11/images/stripe_1.png){{/if}}"}
      %input{:name => "{{if (type == 'nil')}}subject[${type}][hi_res]{{else}}subject[${type}][${id}][hi_res]{{/if}}", :type => "hidden", :value => "false"}
      <input name="{{if (type == 'nil')}}subject[${type}][hi_res]{{else}}subject[${type}][${id}][hi_res]{{/if}}" type="checkbox" value="true" {{if hi_res}}checked="checked"{{/if}}>
    {{if (type != 'nil')}}
    %td
      = link_to _("Löschen"), "#", :class => "delete", :msg => _("Sind Sie sicher?")
    {{/if}}

   
:javascript

  $(function() {
    var data = #{@media_entries_json};
    $("#list_as_thumbnails").html($("#thumbnail_view").tmpl(data));
    
    
    var permissions = #{@json};
    $('#user_permissions').html($("#new_permission").tmpl(permissions.User));
    
    $('#group_permissions').html($("#new_permission").tmpl(permissions.Group));   

    $('#anyone_permissions').html($("#new_permission").tmpl(permissions.public));


    $("input#new_user").autocomplete({
      source: "/users",
      minLength: 3,
      select: function(event, ui) {
        var data = {type: 'User', id: ui.item.id, name: ui.item.label, view: false, edit: false, hi_res: false }
        $('#user_permissions').append($("#new_permission").tmpl(data)).effect('highlight');
        $(this).val('');
      }
    });

    $("input#new_group").autocomplete({
      source: "/groups",
      minLength: 3,
      select: function(event, ui) {
        var data = {type: 'Group', id: ui.item.id, name: ui.item.label, view: false, edit: false, hi_res: false }
        $('#group_permissions').append($("#new_permission").tmpl(data)).effect('highlight');
      }
    });
    
    // TODO override rails.js data-method and data-confirm
    $(".permissions a.delete[msg]").live('click', function(){
      var element = $(this);
      var message = element.attr('msg');
      if(confirm(message)){
        var to_remove = element.closest("tr");
        to_remove.fadeOut('slow', function() {
          to_remove.remove();
        });
      }
      return false;
    });
  });

    