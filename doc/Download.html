<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Download
  
    &mdash; Documentation by YARD 0.7.4
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (D)</a> &raquo; 
    
    
    <span class="title">Download</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Download
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Download</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/logic/download.rb</dd>
  
</dl>
<div class="clear"></div>






  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#call-class_method" title="call (class method)">+ (Object) <strong>call</strong>(env) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="call-class_method">
  
    + (<tt>Object</tt>) <strong>call</strong>(env) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/logic/download.rb', line 4</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_env'>env</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span> <span class='op'>=</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Request</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_env'>env</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_params'>params</span>
    <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rack.session</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
    
    <span class='id identifier rubyid_current_user'>current_user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span>
    <span class='comment'># TODO permission check
</span>
<span class='comment'># e.g.
</span><span class='comment'># 'zip' param present means original file + xml sidecar of meta-data all zipped as one file
</span><span class='comment'># 'update' param present means original file updated by exiftool with current state of madek meta-data for that mediaentry
</span><span class='comment'># (update and zip should be treated as mutally exclusive in the context of one download call)
</span><span class='comment'># neither zip nor update present? just give the original file, as it was uploaded.
</span><span class='comment'># WE SHOULD NEVER UPDATE AN UPLOADED FILE WITH MADEK METADATA.
</span>
<span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span>
    
    <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>id</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> 

      <span class='ivar'>@media_entry</span> <span class='op'>=</span> <span class='const'>MediaEntry</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>id</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

      <span class='kw'>unless</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

        <span class='comment'># This is broken, presumably because of ruby 1.8.x not having any native idea of character encodings.
</span>        <span class='comment'># If we move the gsub to execute after the unescape has processed, we can easily lose part of the 
</span>        <span class='comment'># filename if it contains diacritics and spaces.
</span>        <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='const'>CGI</span><span class='op'>::</span><span class='id identifier rubyid_unescape'>unescape</span><span class='lparen'>(</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\+</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_is_preview'>is_preview</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>size</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>video_thumbnail</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>audio_preview</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_is_preview'>is_preview</span>
          <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sie haben nicht die notwendige Zugriffsberechtigung.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span> <span class='kw'>unless</span> <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='symbol'>:view</span><span class='comma'>,</span> <span class='ivar'>@media_entry</span><span class='rparen'>)</span> 
          
          <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>size</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:to_sym</span><span class='rparen'>)</span>
                      
          <span class='comment'># This isn't video or audio, it's a plain old image
</span>          <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_size'>size</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>video_thumbnail</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>audio_preview</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_preview'>preview</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_get_preview'>get_preview</span><span class='lparen'>(</span><span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_content_type'>content_type</span>
            <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_filename'>filename</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='comma'>,</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_guid'>guid</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span>
            
          <span class='comment'># Video files get a WebM preview file
</span>          <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>video_thumbnail</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>video/webm</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_preview'>preview</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_previews'>previews</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
              <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>404</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Preview file not found.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
            <span class='kw'>else</span>
              <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span> <span class='comment'># The filename going out to the browser
</span>              <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>THUMBNAIL_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_shard'>shard</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
              <span class='comment'># this return seems to be handled later on anyhow                
</span>              <span class='comment'>#return [200, {&quot;Content-Type&quot; =&gt; content_type, &quot;Content-Disposition&quot; =&gt; &quot;attachment; filename=#{@media_entry.media_file.filename}&quot; }, [File.read(path) ]]
</span>            <span class='kw'>end</span>     
            
          <span class='comment'># Audio files get an Ogg Vorbis preview file
</span>          <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>audio_preview</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>audio/ogg</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_preview'>preview</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_previews'>previews</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
              <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>404</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Preview file not found.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
            <span class='kw'>else</span>
              <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span> <span class='comment'># The filename going out to the browser
</span>              <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>THUMBNAIL_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_shard'>shard</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
              <span class='comment'># this return seems to be handled later on anyhow
</span>              <span class='comment'>#return [200, {&quot;Content-Type&quot; =&gt; content_type, &quot;Content-Disposition&quot; =&gt; &quot;attachment; filename=#{@media_entry.media_file.filename}&quot; }, [File.read(path) ]]
</span>            <span class='kw'>end</span>
            
          <span class='comment'># This isn't any preview we can handle
</span>          <span class='kw'>else</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Don't know how to handle this type of preview.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>end</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_content_type'>content_type</span>
          <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sie haben nicht die notwendige Zugriffsberechtigung.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span> <span class='kw'>unless</span> <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='symbol'>:hi_res</span><span class='comma'>,</span> <span class='ivar'>@media_entry</span><span class='rparen'>)</span> 
        <span class='kw'>end</span>


<span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'># A media file updated with current madek meta-data, zipped up together with a bunch of side-car meta-data files.
</span><span class='comment'># At present these are yaml and xml files, but they are pretty raw ATM - exposing the internals of the model/schema
</span><span class='comment'># instead of following a well formed and easier to comprehend xml/yml schema..
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span>        <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>zip</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>

          <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span> <span class='comment'># false means we don't want to blank all the tags
</span>
          <span class='comment'># create the zipfile - we need a name that hopefully won't collide as it's being written to..
</span>          <span class='id identifier rubyid_race_free_filename'>race_free_filename</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

          <span class='const'>Zip</span><span class='op'>::</span><span class='const'>ZipOutputStream</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>ZIP_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_race_free_filename'>race_free_filename</span><span class='rbrace'>}</span><span class='tstring_content'>.zip</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
            <span class='op'>|</span><span class='id identifier rubyid_zos'>zos</span><span class='op'>|</span>
            <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_put_next_entry'>put_next_entry</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_put_next_entry'>put_next_entry</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_content'>.xml</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
            <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_to_xml'>to_xml</span><span class='lparen'>(</span><span class='symbol'>:include</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='symbol'>:meta_data</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='symbol'>:include</span> <span class='op'>=&gt;</span> <span class='symbol'>:meta_key</span><span class='rbrace'>}</span><span class='rbrace'>}</span> <span class='rparen'>)</span>
            
            <span class='comment'># FIXME yaml not working properly anymore!
</span>            <span class='comment'># YAML::ENGINE.yamler='psych'
</span>            <span class='comment'># zos.put_next_entry(&quot;#{filename}.yml&quot;)
</span>            <span class='comment'># zos.print @media_entry.to_yaml(:include =&gt; {:meta_data =&gt; {:include =&gt; :meta_key}} )
</span>            <span class='comment'># YAML::ENGINE.yamler='syck'
</span>          <span class='kw'>end</span>

          <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>200</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>application/zip</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Disposition</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attachment; filename=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_content'>.zip</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> 
                  <span class='lbracket'>[</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>ZIP_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_race_free_filename'>race_free_filename</span><span class='rbrace'>}</span><span class='tstring_content'>.zip</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>else</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Something went wrong!</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>end</span>

            <span class='comment'># TODO - Background job submission to remove the unlocked (ie downloaded) zipfile.
</span>            <span class='comment'># since it fails if we try here (because the file is locked while the user 
</span>            <span class='comment'># downloads it at some arbitrarily slow speed)
</span>        <span class='kw'>end</span>

<span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'># An updated file - updated with the current set of madek meta-data
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span>        <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>update</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>

          <span class='comment'># path = @media_entry.media_file.update_file_metadata(@media_entry.to_metadata_tags)
</span>          <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span> <span class='comment'># false means we don't want to blank all the tags
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>200</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Disposition</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attachment; filename=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>else</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Something went wrong!</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>


<span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'># A bare file - as little meta-data as can be allowed without breaking the file.
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span>        <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>naked</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>

          <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span> <span class='comment'># true means we do want to blank all the tags
</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>200</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Disposition</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attachment; filename=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>else</span>
            <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>500</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text/html</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Something went wrong!</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>

<span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'># Provide a copy of the original file, not updated or nuffin'
</span><span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span>
        <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_file_storage_location'>file_storage_location</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_size'>size</span>
          <span class='id identifier rubyid_outfile'>outfile</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='const'>DOWNLOAD_STORAGE_DIR</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='rparen'>)</span>
          <span class='backtick'>`</span><span class='tstring_content'>convert &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>&quot; -resize &quot;</span><span class='embexpr_beg'>#{</span><span class='const'>THUMBNAILS</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>&quot; &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_outfile'>outfile</span><span class='rbrace'>}</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>`</span></span>
          <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='id identifier rubyid_outfile'>outfile</span>
        <span class='kw'>end</span>
        
        <span class='comment'># return [200, {&quot;Content-Type&quot; =&gt; &quot;text/html&quot;}, [ &quot;#{filename.inspect}&quot; ]] # temp debugging aid
</span>        <span class='kw'>return</span> <span class='lbracket'>[</span><span class='int'>200</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Disposition</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attachment; filename=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='rbracket'>]</span><span class='rbracket'>]</span>
      <span class='kw'>end</span>

    <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu Dec 22 13:34:26 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.4 (ruby-1.9.2).
</div>

  </body>
</html>