<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: DownloadController
  
    &mdash; Documentation by YARD 0.7.5
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (D)</a> &raquo; 
    
    
    <span class="title">DownloadController</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: DownloadController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActionController::Base</li>
          
            <li class="next"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></li>
          
            <li class="next">DownloadController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/controllers/download_controller.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#download-instance_method" title="#download (instance method)">- (Object) <strong>download</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_as_zip-instance_method" title="#send_as_zip (instance method)">- (Object) <strong>send_as_zip</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A media file updated with current madek meta-data, zipped up together with
a bunch of side-car meta-data files.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_multimedia_preview-instance_method" title="#send_multimedia_preview (instance method)">- (Object) <strong>send_multimedia_preview</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_naked_file-instance_method" title="#send_naked_file (instance method)">- (Object) <strong>send_naked_file</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A bare file - as little meta-data as can be allowed without breaking the
file.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_original_file-instance_method" title="#send_original_file (instance method)">- (Object) <strong>send_original_file</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_preview-instance_method" title="#send_preview (instance method)">- (Object) <strong>send_preview</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_updated_file-instance_method" title="#send_updated_file (instance method)">- (Object) <strong>send_updated_file</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>An updated file - updated with the current set of madek meta-data.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ApplicationController.html#_-instance_method" title="ApplicationController#_ (method)">#_</a></span>, <span class='object_link'><a href="ApplicationController.html#catalog-instance_method" title="ApplicationController#catalog (method)">#catalog</a></span>, <span class='object_link'><a href="ApplicationController.html#current_user-instance_method" title="ApplicationController#current_user (method)">#current_user</a></span>, <span class='object_link'><a href="ApplicationController.html#feedback-instance_method" title="ApplicationController#feedback (method)">#feedback</a></span>, <span class='object_link'><a href="ApplicationController.html#help-instance_method" title="ApplicationController#help (method)">#help</a></span>, <span class='object_link'><a href="ApplicationController.html#logged_in%3F-instance_method" title="ApplicationController#logged_in? (method)">#logged_in?</a></span>, <span class='object_link'><a href="ApplicationController.html#root-instance_method" title="ApplicationController#root (method)">#root</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="download-instance_method">
  
    - (<tt>Object</tt>) <strong>download</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 4</span>

<span class='kw'>def</span> <span class='id identifier rubyid_download'>download</span>
  
<span class='comment'># e.g.
</span><span class='comment'># 'zip' param present means original file + xml sidecar of meta-data all zipped as one file
</span><span class='comment'># 'update' param present means original file updated by exiftool with current state of madek meta-data for that mediaentry
</span><span class='comment'># (update and zip should be treated as mutally exclusive in the context of one download call)
</span><span class='comment'># neither zip nor update present? just give the original file, as it was uploaded.
</span><span class='comment'># WE SHOULD NEVER UPDATE AN UPLOADED FILE WITH MADEK METADATA.
</span>
<span class='comment'>#####################################################################################################################
</span><span class='comment'>#####################################################################################################################
</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> 

      <span class='ivar'>@media_entry</span> <span class='op'>=</span> <span class='const'>MediaEntry</span><span class='period'>.</span><span class='id identifier rubyid_accessible_by_user'>accessible_by_user</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

      <span class='kw'>if</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_not_authorized!'>not_authorized!</span>
      <span class='kw'>else</span>
        <span class='comment'># This is broken, presumably because of ruby 1.8.x not having any native idea of character encodings.
</span>        <span class='comment'># If we move the gsub to execute after the unescape has processed, we can easily lose part of the 
</span>        <span class='comment'># filename if it contains diacritics and spaces.       
</span>        <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='const'>CGI</span><span class='op'>::</span><span class='id identifier rubyid_unescape'>unescape</span><span class='lparen'>(</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\+</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rparen'>)</span>

        <span class='ivar'>@size</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:size</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:to_sym</span><span class='rparen'>)</span>           
        <span class='ivar'>@content_type</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_content_type'>content_type</span>

        <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:zip</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          <span class='id identifier rubyid_send_as_zip'>send_as_zip</span>
        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:update</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          <span class='id identifier rubyid_send_updated_file'>send_updated_file</span>
        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:naked</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          <span class='id identifier rubyid_send_naked_file'>send_naked_file</span>
          
        <span class='comment'># Video files get a WebM preview file
</span>        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:video_thumbnail</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          <span class='ivar'>@content_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>video/webm</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_preview'>preview</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_previews'>previews</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='ivar'>@content_type</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Preview file not found.</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>404</span>
          <span class='kw'>else</span>
            <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span> <span class='comment'># The filename going out to the browser
</span>            <span class='ivar'>@path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>THUMBNAIL_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_shard'>shard</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_send_multimedia_preview'>send_multimedia_preview</span>
          <span class='kw'>end</span>
          
        <span class='comment'># Audio files get an Ogg Vorbis preview file            
</span>        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:audio_preview</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          <span class='ivar'>@content_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>audio/ogg</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_preview'>preview</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_previews'>previews</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:content_type</span> <span class='op'>=&gt;</span> <span class='ivar'>@content_type</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Preview file not found.</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>404</span>
          <span class='kw'>else</span>
            <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span> <span class='comment'># The filename going out to the browser
</span>            <span class='ivar'>@path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>THUMBNAIL_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_shard'>shard</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_send_multimedia_preview'>send_multimedia_preview</span>
          <span class='kw'>end</span>
          
        <span class='comment'># We use @size to find out if we have to send a resized preview -- this is pretty bad
</span>        <span class='kw'>elsif</span> <span class='op'>!</span><span class='ivar'>@size</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          <span class='id identifier rubyid_send_preview'>send_preview</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_send_original_file'>send_original_file</span>
        <span class='kw'>end</span>
        
      <span class='kw'>end</span>
    <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="send_as_zip-instance_method">
  
    - (<tt>Object</tt>) <strong>send_as_zip</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>A media file updated with current madek meta-data, zipped up together with
a bunch of side-car meta-data files. At present these are yaml and xml
files, but they are pretty raw ATM - exposing the internals of the
model/schema instead of following a well formed and easier to comprehend
xml/yml schema..</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 99</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_as_zip'>send_as_zip</span>
  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='kw'>false</span><span class='comma'>,</span> <span class='ivar'>@size</span><span class='rparen'>)</span> <span class='comment'># false means we don't want to blank all the tags
</span>
  <span class='comment'># create the zipfile - we need a name that hopefully won't collide as it's being written to..
</span>  <span class='id identifier rubyid_race_free_filename'>race_free_filename</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@filename</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

  <span class='const'>Zip</span><span class='op'>::</span><span class='const'>ZipOutputStream</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>ZIP_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_race_free_filename'>race_free_filename</span><span class='rbrace'>}</span><span class='tstring_content'>.zip</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_zos'>zos</span><span class='op'>|</span>
    <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_put_next_entry'>put_next_entry</span><span class='lparen'>(</span><span class='ivar'>@filename</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_put_next_entry'>put_next_entry</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@filename</span><span class='rbrace'>}</span><span class='tstring_content'>.xml</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_zos'>zos</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_to_xml'>to_xml</span><span class='lparen'>(</span><span class='symbol'>:include</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='symbol'>:meta_data</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='symbol'>:include</span> <span class='op'>=&gt;</span> <span class='symbol'>:meta_key</span><span class='rbrace'>}</span><span class='rbrace'>}</span> <span class='rparen'>)</span>
    
    <span class='comment'># FIXME yaml not working properly anymore!
</span>    <span class='comment'># YAML::ENGINE.yamler='psych'
</span>    <span class='comment'># zos.put_next_entry(&quot;#{filename}.yml&quot;)
</span>    <span class='comment'># zos.print @media_entry.to_yaml(:include =&gt; {:meta_data =&gt; {:include =&gt; :meta_key}} )
</span>    <span class='comment'># YAML::ENGINE.yamler='syck'
</span>  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
      <span class='id identifier rubyid_fixed_send_file'>fixed_send_file</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>ZIP_STORAGE_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_race_free_filename'>race_free_filename</span><span class='rbrace'>}</span><span class='tstring_content'>.zip</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                      <span class='lbrace'>{</span><span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_race_free_filename'>race_free_filename</span><span class='rbrace'>}</span><span class='tstring_content'>.zip</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                       <span class='symbol'>:type</span>          <span class='op'>=&gt;</span>  <span class='ivar'>@content_type</span><span class='comma'>,</span>
                       <span class='symbol'>:disposition</span>  <span class='op'>=&gt;</span>  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>attachment</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>  
  <span class='kw'>else</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>500</span>
  <span class='kw'>end</span>

  <span class='comment'># TODO - Background job submission to remove the unlocked (ie downloaded) zipfile.
</span>  <span class='comment'># since it fails if we try here (because the file is locked while the user 
</span>  <span class='comment'># downloads it at some arbitrarily slow speed)
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="send_multimedia_preview-instance_method">
  
    - (<tt>Object</tt>) <strong>send_multimedia_preview</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


177
178
179
180
181
182</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 177</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_multimedia_preview'>send_multimedia_preview</span>
  <span class='id identifier rubyid_fixed_send_file'>fixed_send_file</span><span class='lparen'>(</span><span class='ivar'>@path</span><span class='comma'>,</span>
                 <span class='lbrace'>{</span><span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='ivar'>@filename</span><span class='comma'>,</span>
                  <span class='symbol'>:type</span>          <span class='op'>=&gt;</span>  <span class='ivar'>@content_type</span><span class='comma'>,</span>
                  <span class='symbol'>:disposition</span>  <span class='op'>=&gt;</span>  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>attachment</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="send_naked_file-instance_method">
  
    - (<tt>Object</tt>) <strong>send_naked_file</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>A bare file - as little meta-data as can be allowed without breaking the
file.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


149
150
151
152
153
154
155
156
157
158
159
160</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 149</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_naked_file'>send_naked_file</span>
  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='kw'>true</span><span class='comma'>,</span> <span class='ivar'>@size</span><span class='rparen'>)</span> <span class='comment'># true means we do want to blank all the tags
</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
      <span class='id identifier rubyid_fixed_send_file'>fixed_send_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span>
                      <span class='lbrace'>{</span><span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='ivar'>@filename</span><span class='comma'>,</span>
                       <span class='symbol'>:type</span>          <span class='op'>=&gt;</span>  <span class='ivar'>@content_type</span><span class='comma'>,</span>
                       <span class='symbol'>:disposition</span>  <span class='op'>=&gt;</span>  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>attachment</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>            
  <span class='kw'>else</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>500</span>
  <span class='kw'>end</span>    
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="send_original_file-instance_method">
  
    - (<tt>Object</tt>) <strong>send_original_file</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


162
163
164
165
166
167
168
169
170
171
172
173
174
175</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 162</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_original_file'>send_original_file</span>
  <span class='comment'># Provide a copy of the original file, not updated or nuffin'
</span>  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_file_storage_location'>file_storage_location</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span>

  <span class='comment'>#send_file(path,
</span>  <span class='comment'>#           :filename =&gt; @filename,
</span>  <span class='comment'>#           :type          =&gt;  @content_type,
</span>  <span class='comment'>#           :disposition  =&gt;  'attachment')
</span>  <span class='id identifier rubyid_fixed_send_file'>fixed_send_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span>
                  <span class='lbrace'>{</span><span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='ivar'>@filename</span><span class='comma'>,</span>
                   <span class='symbol'>:type</span>          <span class='op'>=&gt;</span>  <span class='ivar'>@content_type</span><span class='comma'>,</span>
                   <span class='symbol'>:disposition</span>  <span class='op'>=&gt;</span>  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>attachment</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="send_preview-instance_method">
  
    - (<tt>Object</tt>) <strong>send_preview</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 75</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_preview'>send_preview</span>
  <span class='comment'># This isn't video or audio, it's a plain old image
</span>  <span class='id identifier rubyid_preview'>preview</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_get_preview'>get_preview</span><span class='lparen'>(</span><span class='ivar'>@size</span><span class='rparen'>)</span>
  <span class='ivar'>@content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_content_type'>content_type</span>
  <span class='ivar'>@filename</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='ivar'>@filename</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='comma'>,</span> <span class='id identifier rubyid_preview'>preview</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_guid'>guid</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span>
  
  <span class='comment'># Provide a copy of the original file, not updated or nuffin'
</span>  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_file_storage_location'>file_storage_location</span>
  <span class='kw'>if</span> <span class='ivar'>@size</span>
    <span class='id identifier rubyid_outfile'>outfile</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='const'>DOWNLOAD_STORAGE_DIR</span><span class='comma'>,</span> <span class='ivar'>@filename</span><span class='rparen'>)</span>
    <span class='backtick'>`</span><span class='tstring_content'>convert &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>&quot; -resize &quot;</span><span class='embexpr_beg'>#{</span><span class='const'>THUMBNAILS</span><span class='lbracket'>[</span><span class='ivar'>@size</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>&quot; &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_outfile'>outfile</span><span class='rbrace'>}</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>`</span></span>
    <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='id identifier rubyid_outfile'>outfile</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_fixed_send_file'>fixed_send_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span>
                 <span class='lbrace'>{</span><span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='ivar'>@filename</span><span class='comma'>,</span>
                  <span class='symbol'>:type</span>          <span class='op'>=&gt;</span>  <span class='ivar'>@content_type</span><span class='comma'>,</span>
                  <span class='symbol'>:disposition</span>  <span class='op'>=&gt;</span>  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>attachment</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="send_updated_file-instance_method">
  
    - (<tt>Object</tt>) <strong>send_updated_file</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>An updated file - updated with the current set of madek meta-data</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


134
135
136
137
138
139
140
141
142
143
144
145</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/download_controller.rb', line 134</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_updated_file'>send_updated_file</span>
  <span class='comment'># path = @media_entry.media_file.update_file_metadata(@media_entry.to_metadata_tags)
</span>  <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='ivar'>@media_entry</span><span class='period'>.</span><span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='kw'>false</span><span class='comma'>,</span> <span class='ivar'>@size</span><span class='rparen'>)</span> <span class='comment'># false means we don't want to blank all the tags
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_path'>path</span>
    <span class='id identifier rubyid_fixed_send_file'>fixed_send_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span>
                    <span class='lbrace'>{</span><span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='ivar'>@filename</span><span class='comma'>,</span>
                     <span class='symbol'>:type</span>          <span class='op'>=&gt;</span>  <span class='ivar'>@content_type</span><span class='comma'>,</span>
                     <span class='symbol'>:disposition</span>  <span class='op'>=&gt;</span>  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>attachment</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>            
  <span class='kw'>else</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>500</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Feb 28 17:17:07 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.5 (ruby-1.9.3).
</div>

  </body>
</html>