<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: MediaResource
  
    &mdash; Documentation by YARD 0.7.5
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo; 
    
    
    <span class="title">MediaResource</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: MediaResource
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">ActiveRecord::Base</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActiveRecord::Base</li>
          
            <li class="next">MediaResource</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/models/media_resource.rb</dd>
  
</dl>
<div class="clear"></div>

<div id="subclasses">
  <h2>Direct Known Subclasses</h2>
  <p class="children"><span class='object_link'><a href="MediaEntry.html" title="MediaEntry (class)">MediaEntry</a></span>, <span class='object_link'><a href="MediaSet.html" title="MediaSet (class)">MediaSet</a></span>, <span class='object_link'><a href="Snapshot.html" title="Snapshot (class)">Snapshot</a></span></p>
</div>







  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#accessible_by_user-class_method" title="accessible_by_user (class method)">+ (Object) <strong>accessible_by_user</strong>(user, action = :view) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#filter_media_file-class_method" title="filter_media_file (class method)">+ (Object) <strong>filter_media_file</strong>(options = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reindex-class_method" title="reindex (class method)">+ (Object) <strong>reindex</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_tms_doc-class_method" title="to_tms_doc (class method)">+ (Object) <strong>to_tms_doc</strong>(resources, context = MetaContext.tms) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>TODO move down to Snapshot class.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#as_json-instance_method" title="#as_json (instance method)">- (Object) <strong>as_json</strong>(options = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#context_valid%3F-instance_method" title="#context_valid? (instance method)">- (Boolean) <strong>context_valid?</strong>(context = MetaContext.core) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#context_warnings-instance_method" title="#context_warnings (instance method)">- (Object) <strong>context_warnings</strong>(context = MetaContext.core) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_basic_info-instance_method" title="#get_basic_info (instance method)">- (Object) <strong>get_basic_info</strong>(current_user, extended_keys = [], with_thumb = false) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>TODO merge to as_json.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#is_private%3F-instance_method" title="#is_private? (instance method)">- (Boolean) <strong>is_private?</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#is_public%3F-instance_method" title="#is_public? (instance method)">- (Boolean) <strong>is_public?</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#managers-instance_method" title="#managers (instance method)">- (Object) <strong>managers</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#media_type-instance_method" title="#media_type (instance method)">- (Object) <strong>media_type</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#meta_data_for_context-instance_method" title="#meta_data_for_context (instance method)">- (Object) <strong>meta_data_for_context</strong>(context = MetaContext.core, build_if_not_exists = true) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parents-instance_method" title="#parents (instance method)">- (Object) <strong>parents</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reindex-instance_method" title="#reindex (instance method)">- (Object) <strong>reindex</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#title-instance_method" title="#title (instance method)">- (Object) <strong>title</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>scope :without_meta_data, :select =&gt; "media_entries.*",.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#title_and_user-instance_method" title="#title_and_user (instance method)">- (Object) <strong>title_and_user</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_attributes_with_pre_validation-instance_method" title="#update_attributes_with_pre_validation (instance method)">- (Object) <strong>update_attributes_with_pre_validation</strong>(attributes, current_user = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#updated_resource_file-instance_method" title="#updated_resource_file (instance method)">- (Object) <strong>updated_resource_file</strong>(blank_all_tags = false, size = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Instance method to update a copy (referenced by path) of a media file with
the meta_data tags provided args: blank_all_tags = flag indicating whether
we clean all the tags from the file, or update the tags in the file
returns: the path and filename of the updated copy or nil (if the copy
failed).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#users_permitted_to_act-instance_method" title="#users_permitted_to_act (instance method)">- (Object) <strong>users_permitted_to_act</strong>(action) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="accessible_by_user-class_method">
  
    + (<tt>Object</tt>) <strong>accessible_by_user</strong>(user, action = :view) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 456</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_accessible_by_user'>accessible_by_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_action'>action</span> <span class='op'>=</span> <span class='symbol'>:view</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_action'>action</span> <span class='op'>=</span> <span class='id identifier rubyid_action'>action</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span>
  
  <span class='kw'>unless</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_action'>action</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_resource_ids_by_userpermission'>resource_ids_by_userpermission</span> <span class='op'>=</span> <span class='const'>Userpermission</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resource_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_action'>action</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_resource_ids_by_userpermission_disallowed'>resource_ids_by_userpermission_disallowed</span><span class='op'>=</span> <span class='const'>Userpermission</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resource_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_action'>action</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_resource_ids_by_grouppermission_but_not_disallowed'>resource_ids_by_grouppermission_but_not_disallowed</span> <span class='op'>=</span> <span class='const'>Grouppermission</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resource_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_action'>action</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INNER JOIN groups_users ON groups_users.group_id = grouppermissions.group_id </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>groups_users.user_id = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> media_resource_id NOT IN ( </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resource_ids_by_userpermission_disallowed'>resource_ids_by_userpermission_disallowed</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'> )</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_resource_ids_by_ownership_or_public_permission'>resource_ids_by_ownership_or_public_permission</span> <span class='op'>=</span> <span class='const'>MediaResource</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resources.id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resources.user_id = ? OR media_resources.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action'>action</span><span class='rbrace'>}</span><span class='tstring_content'> = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rbracket'>]</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_where'>where</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> media_resources.id IN  (
          </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resource_ids_by_userpermission'>resource_ids_by_userpermission</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'> 
      UNION
          </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resource_ids_by_grouppermission_but_not_disallowed'>resource_ids_by_grouppermission_but_not_disallowed</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'> 
      UNION
          </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resource_ids_by_ownership_or_public_permission'>resource_ids_by_ownership_or_public_permission</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'>
            )</span><span class='tstring_end'>&quot;</span></span> 
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="filter_media_file-class_method">
  
    + (<tt>Object</tt>) <strong>filter_media_file</strong>(options = {}) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 398</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_filter_media_file'>filter_media_file</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='id identifier rubyid_media_entries'>media_entries</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RIGHT JOIN media_files ON media_resources.media_file_id = media_files.id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:width</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:width</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_operator'>operator</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:width</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:operator</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gt</span><span class='tstring_end'>&quot;</span></span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lt</span><span class='tstring_end'>&quot;</span></span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='id identifier rubyid_sql'>sql</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_files.width </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_operator'>operator</span><span class='rbrace'>}</span><span class='tstring_content'> ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:width</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:height</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:height</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_operator'>operator</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:height</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:operator</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gt</span><span class='tstring_end'>&quot;</span></span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lt</span><span class='tstring_end'>&quot;</span></span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='id identifier rubyid_sql'>sql</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_files.height </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_operator'>operator</span><span class='rbrace'>}</span><span class='tstring_content'> ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:height</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:orientation</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_operator'>operator</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:orientation</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='kw'>when</span> <span class='int'>0</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='int'>1</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='id identifier rubyid_sql'>sql</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_files.height </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_operator'>operator</span><span class='rbrace'>}</span><span class='tstring_content'> media_files.width</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_sql'>sql</span>    
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="reindex-class_method">
  
    + (<tt>Object</tt>) <strong>reindex</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


394
395
396</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 394</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reindex'>reindex</span>
  <span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:reindex</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="to_tms_doc-class_method">
  
    + (<tt>Object</tt>) <strong>to_tms_doc</strong>(resources, context = MetaContext.tms) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>TODO move down to Snapshot class</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


254
255
256
257
258
259
260
261
262</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 254</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_to_tms_doc'>to_tms_doc</span><span class='lparen'>(</span><span class='id identifier rubyid_resources'>resources</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_tms'>tms</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_xml'>xml</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>Builder</span><span class='op'>::</span><span class='const'>XmlMarkup</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_xml'>xml</span><span class='period'>.</span><span class='id identifier rubyid_instruct!'>instruct!</span>
  <span class='id identifier rubyid_xml'>xml</span><span class='period'>.</span><span class='id identifier rubyid_madek'>madek</span><span class='lparen'>(</span><span class='symbol'>:version</span> <span class='op'>=&gt;</span> <span class='const'>RELEASE_VERSION</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_resources'>resources</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_resource'>resource</span><span class='op'>|</span>
      <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_to_tms'>to_tms</span><span class='lparen'>(</span><span class='id identifier rubyid_xml'>xml</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="as_json-instance_method">
  
    - (<tt>Object</tt>) <strong>as_json</strong>(options = {}) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 198</span>

<span class='kw'>def</span> <span class='id identifier rubyid_as_json'>as_json</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_with_thumb'>with_thumb</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:with_thumb</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_more_json'>more_json</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span>
    <span class='comment'>#TODO Dont do this behaviour on default
</span>    <span class='id identifier rubyid_is_public'>is_public</span> <span class='op'>=</span> <span class='id identifier rubyid_is_public?'>is_public?</span>
    <span class='id identifier rubyid_is_private'>is_private</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_is_public'>is_public</span> <span class='op'>?</span> <span class='kw'>false</span> <span class='op'>:</span> <span class='id identifier rubyid_is_private?'>is_private?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_flags'>flags</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:is_public</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_is_public'>is_public</span><span class='comma'>,</span>
              <span class='symbol'>:is_private</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_is_private'>is_private</span><span class='comma'>,</span>
              <span class='symbol'>:is_shared</span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_is_public'>is_public</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_is_private'>is_private</span><span class='rparen'>)</span><span class='comma'>,</span>
              <span class='symbol'>:is_editable</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='symbol'>:edit</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span><span class='comma'>,</span>
              <span class='symbol'>:is_manageable</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='symbol'>:manage</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span><span class='comma'>,</span>
              <span class='symbol'>:is_favorite</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_favorite_ids'>favorite_ids</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_more_json'>more_json</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span> <span class='id identifier rubyid_flags'>flags</span>         
    <span class='id identifier rubyid_more_json'>more_json</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_basic_info'>get_basic_info</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_with_thumb'>with_thumb</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_default_options'>default_options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:only</span> <span class='op'>=&gt;</span> <span class='symbol'>:id</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_json'>json</span> <span class='op'>=</span> <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_default_options'>default_options</span><span class='period'>.</span><span class='id identifier rubyid_deep_merge'>deep_merge</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span><span class='rparen'>)</span>
  
  <span class='kw'>if</span><span class='lparen'>(</span><span class='id identifier rubyid_with'>with</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:with</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>if</span><span class='lparen'>(</span><span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='symbol'>:image</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:image</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='kw'>not</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:image</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:image</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:size</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='symbol'>:small</span>
        
        <span class='id identifier rubyid_json'>json</span><span class='lbracket'>[</span><span class='symbol'>:image</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:image</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:as</span><span class='rbracket'>]</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>base64</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_mf'>mf</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>MediaSet</span><span class='rparen'>)</span>
              <span class='id identifier rubyid_media_entries'>media_entries</span><span class='period'>.</span><span class='id identifier rubyid_accessible_by_user'>accessible_by_user</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:current_user</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resources.updated_at DESC</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:media_file</span><span class='rparen'>)</span>
            <span class='kw'>else</span>
              <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span>
            <span class='kw'>end</span>
            <span class='id identifier rubyid_mf'>mf</span> <span class='op'>?</span> <span class='id identifier rubyid_mf'>mf</span><span class='period'>.</span><span class='id identifier rubyid_thumb_base64'>thumb_base64</span><span class='lparen'>(</span><span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='kw'>nil</span>
          <span class='kw'>else</span> <span class='comment'># default return is a url to the image
</span>            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/resources/%d/image?size=%s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span>
        <span class='kw'>end</span>            
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='symbol'>:title</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:title</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='kw'>not</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:title</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_json'>json</span><span class='lbracket'>[</span><span class='symbol'>:title</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get_value_for'>get_value_for</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='symbol'>:author</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:author</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='kw'>not</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:author</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_json'>json</span><span class='lbracket'>[</span><span class='symbol'>:author</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get_value_for'>get_value_for</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>author</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='symbol'>:type</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='kw'>not</span> <span class='id identifier rubyid_with'>with</span><span class='lbracket'>[</span><span class='symbol'>:media_resource</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_json'>json</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_type'>type</span><span class='period'>.</span><span class='id identifier rubyid_underscore'>underscore</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  
  <span class='id identifier rubyid_json'>json</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_more_json'>more_json</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="context_valid?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>context_valid?</strong>(context = MetaContext.core) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


307
308
309</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 307</span>

<span class='kw'>def</span> <span class='id identifier rubyid_context_valid?'>context_valid?</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_core'>core</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_meta_data_for_context'>meta_data_for_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_all?'>all?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='op'>|</span> <span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_context_valid?'>context_valid?</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="context_warnings-instance_method">
  
    - (<tt>Object</tt>) <strong>context_warnings</strong>(context = MetaContext.core) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


293
294
295
296
297
298
299
300
301
302
303
304
305</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 293</span>

<span class='kw'>def</span> <span class='id identifier rubyid_context_warnings'>context_warnings</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_core'>core</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  
  <span class='id identifier rubyid_meta_data_for_context'>meta_data_for_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='op'>|</span>
    <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_context_warnings'>context_warnings</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_w'>w</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_r'>r</span><span class='lbracket'>[</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_meta_key'>meta_key</span><span class='period'>.</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_r'>r</span><span class='lbracket'>[</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_meta_key'>meta_key</span><span class='period'>.</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_w'>w</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_r'>r</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_basic_info-instance_method">
  
    - (<tt>Object</tt>) <strong>get_basic_info</strong>(current_user, extended_keys = [], with_thumb = false) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>TODO merge to as_json</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 150</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_basic_info'>get_basic_info</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='id identifier rubyid_extended_keys'>extended_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_with_thumb'>with_thumb</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_core_keys'>core_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>author</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_core_info'>core_info</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  
  <span class='id identifier rubyid_labels'>labels</span> <span class='op'>=</span> <span class='id identifier rubyid_core_keys'>core_keys</span> <span class='op'>+</span> <span class='id identifier rubyid_extended_keys'>extended_keys</span>
  <span class='id identifier rubyid_labels'>labels</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_label'>label</span><span class='op'>|</span>
    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get_for_labels'>get_for_labels</span><span class='lparen'>(</span><span class='id identifier rubyid_labels'>labels</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_md'>md</span><span class='op'>|</span>
    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='id identifier rubyid_md'>md</span><span class='period'>.</span><span class='id identifier rubyid_meta_key'>meta_key</span><span class='period'>.</span><span class='id identifier rubyid_label'>label</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_md'>md</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>end</span>
  
        
  <span class='kw'>if</span> <span class='id identifier rubyid_with_thumb'>with_thumb</span>
    <span class='id identifier rubyid_mf'>mf</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>MediaSet</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_media_entries'>media_entries</span><span class='period'>.</span><span class='id identifier rubyid_accessible_by_user'>accessible_by_user</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resources.updated_at DESC</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:media_file</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>thumb_base64</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_mf'>mf</span><span class='period'>.</span><span class='id identifier rubyid_thumb_base64'>thumb_base64</span><span class='lparen'>(</span><span class='symbol'>:small_125</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_mf'>mf</span>
  <span class='kw'>else</span>
    <span class='comment'>#1+n http-requests#
</span>    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>thumb_base64</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/resources/%d/image?size=small_125</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_id'>id</span>
  <span class='kw'>end</span>
  
  <span class='id identifier rubyid_core_info'>core_info</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="is_private?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>is_private?</strong>(user) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


503
504
505
506
507
508</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 503</span>

<span class='kw'>def</span> <span class='id identifier rubyid_is_private?'>is_private?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  <span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>==</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='kw'>and</span>
    <span class='kw'>not</span> <span class='id identifier rubyid_is_public?'>is_public?</span> <span class='kw'>and</span>
    <span class='kw'>not</span> <span class='id identifier rubyid_userpermissions'>userpermissions</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:view</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_id != ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_exists?'>exists?</span> <span class='kw'>and</span>
    <span class='kw'>not</span> <span class='id identifier rubyid_grouppermissions'>grouppermissions</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:view</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_exists?'>exists?</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="is_public?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>is_public?</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


499
500
501</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 499</span>

<span class='kw'>def</span> <span class='id identifier rubyid_is_public?'>is_public?</span>
  <span class='id identifier rubyid_view?'>view?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="managers-instance_method">
  
    - (<tt>Object</tt>) <strong>managers</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


495
496
497</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 495</span>

<span class='kw'>def</span> <span class='id identifier rubyid_managers'>managers</span>
  <span class='id identifier rubyid_users_permitted_to_act'>users_permitted_to_act</span> <span class='symbol'>:manage</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="media_type-instance_method">
  
    - (<tt>Object</tt>) <strong>media_type</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 313</span>

<span class='kw'>def</span> <span class='id identifier rubyid_media_type'>media_type</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:media_file</span><span class='rparen'>)</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_content_type'>content_type</span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>video</span><span class='regexp_end'>/</span></span> <span class='kw'>then</span> 
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Video</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>audio</span><span class='regexp_end'>/</span></span> <span class='kw'>then</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Audio</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>image</span><span class='regexp_end'>/</span></span> <span class='kw'>then</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Image</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span> 
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Doc</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span> 
  <span class='kw'>else</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_type'>type</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>Media</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>    
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="meta_data_for_context-instance_method">
  
    - (<tt>Object</tt>) <strong>meta_data_for_context</strong>(context = MetaContext.core, build_if_not_exists = true) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


277
278
279
280
281
282
283
284
285
286
287
288
289
290
291</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 277</span>

<span class='kw'>def</span> <span class='id identifier rubyid_meta_data_for_context'>meta_data_for_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_core'>core</span><span class='comma'>,</span> <span class='id identifier rubyid_build_if_not_exists'>build_if_not_exists</span> <span class='op'>=</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_meta_keys'>meta_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_meta_keys'>meta_keys</span>

  <span class='id identifier rubyid_mds'>mds</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_meta_keys'>meta_keys</span><span class='rparen'>)</span>
  
  <span class='lparen'>(</span><span class='id identifier rubyid_meta_keys'>meta_keys</span> <span class='op'>-</span> <span class='id identifier rubyid_mds'>mds</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:meta_key</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_is_dynamic?'>is_dynamic?</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span>
    <span class='id identifier rubyid_mds'>mds</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='symbol'>:meta_key</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span> 
  <span class='kw'>end</span>

  <span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_ids'>meta_key_ids</span> <span class='op'>-</span> <span class='id identifier rubyid_mds'>mds</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:meta_key_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key_id'>key_id</span><span class='op'>|</span>
    <span class='id identifier rubyid_mds'>mds</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_key_id'>key_id</span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_build_if_not_exists'>build_if_not_exists</span>
  
  <span class='id identifier rubyid_mds'>mds</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_md'>md</span><span class='op'>|</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_ids'>meta_key_ids</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_md'>md</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_id'>meta_key_id</span><span class='rparen'>)</span> <span class='rbrace'>}</span> 
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="parents-instance_method">
  
    - (<tt>Object</tt>) <strong>parents</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


383
384
385
386
387
388
389
390
391
392</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 383</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parents'>parents</span> 
  <span class='kw'>case</span> <span class='id identifier rubyid_type'>type</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MediaSet</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_parent_sets'>parent_sets</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MediaEntry</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_media_sets'>media_sets</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>parents is not supported (yet) for your type</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="reindex-instance_method">
  
    - (<tt>Object</tt>) <strong>reindex</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


266
267
268
269
270
271
272
273</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 266</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reindex'>reindex</span>
  <span class='id identifier rubyid_ft'>ft</span> <span class='op'>=</span> <span class='id identifier rubyid_full_text'>full_text</span> <span class='op'>||</span> <span class='id identifier rubyid_build_full_text'>build_full_text</span>
  <span class='id identifier rubyid_new_text'>new_text</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_concatenated'>concatenated</span>
  <span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_method'>method</span><span class='op'>|</span>
    <span class='id identifier rubyid_new_text'>new_text</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_method'>method</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='id identifier rubyid_method'>method</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_ft'>ft</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_new_text'>new_text</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="title-instance_method">
  
    - (<tt>Object</tt>) <strong>title</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>scope :without_meta_data, :select =&gt; "media_entries.*",</p>

<pre class="ruby"><span class="ruby-comment">#:joins =&gt; &quot;LEFT JOIN items ON items.model_id = models.id&quot;,</span>
<span class="ruby-comment">#:conditions =&gt; ['items.model_id IS NULL']</span>
</pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


185
186
187
188
189</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 185</span>

<span class='kw'>def</span> <span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get_value_for'>get_value_for</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Ohne Titel</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_t'>t</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="title_and_user-instance_method">
  
    - (<tt>Object</tt>) <strong>title_and_user</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


191
192
193
194</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 191</span>

<span class='kw'>def</span> <span class='id identifier rubyid_title_and_user'>title_and_user</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_title'>title</span><span class='rbrace'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='rbrace'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="update_attributes_with_pre_validation-instance_method">
  
    - (<tt>Object</tt>) <strong>update_attributes_with_pre_validation</strong>(attributes, current_user = nil) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 74</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_attributes_with_pre_validation'>update_attributes_with_pre_validation</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># we need to deep copy the attributes for batch edit (multiple resources)
</span>  <span class='id identifier rubyid_dup_attributes'>dup_attributes</span> <span class='op'>=</span> <span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_deep_symbolize_keys'>deep_symbolize_keys</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span>
    <span class='comment'># To avoid overriding at batch update: remove from attribute hash if :keep_original_value and value is blank
</span>    <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:keep_original_value</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>

    <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_all?'>all?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>
        <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>

      <span class='comment'># find existing meta_datum, if it exists
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:meta_key_label</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:meta_key_id</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>MetaKey</span><span class='period'>.</span><span class='id identifier rubyid_find_by_label'>find_by_label</span><span class='lparen'>(</span><span class='id identifier rubyid_attr'>attr</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meta_key_label</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:id</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_md'>md</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:meta_key_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_md'>md</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_attr'>attr</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meta_key_label</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='comment'># get rid of meta_datum if value is blank
</span>      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
        <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:_destroy</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='comment'>#old# attr[:value] = &quot;.&quot; # NOTE bypass the validation
</span>      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_editors'>editors</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='comment'># OPTIMIZE group by user ??
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='comment'># OPTIMIZE touch
</span>  <span class='id identifier rubyid_update_attributes_without_pre_validation'>update_attributes_without_pre_validation</span><span class='lparen'>(</span><span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="updated_resource_file-instance_method">
  
    - (<tt>Object</tt>) <strong>updated_resource_file</strong>(blank_all_tags = false, size = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Instance method to update a copy (referenced by path) of a media file with
the meta_data tags provided args: blank_all_tags = flag indicating whether
we clean all the tags from the file, or update the tags in the file
returns: the path and filename of the updated copy or nil (if the copy
failed)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 120</span>

<span class='kw'>def</span> <span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='id identifier rubyid_blank_all_tags'>blank_all_tags</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_source_filename'>source_filename</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_size'>size</span>
      <span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_get_preview'>get_preview</span><span class='lparen'>(</span><span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_full_path'>full_path</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_file_storage_location'>file_storage_location</span>
    <span class='kw'>end</span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_cp'>cp</span><span class='lparen'>(</span> <span class='id identifier rubyid_source_filename'>source_filename</span><span class='comma'>,</span> <span class='const'>DOWNLOAD_STORAGE_DIR</span> <span class='rparen'>)</span>
    <span class='comment'># remember we want to handle the following:
</span>    <span class='comment'># include all madek tags in file
</span>    <span class='comment'># remove all (ok, as many as we can) tags from the file.
</span>    <span class='id identifier rubyid_cleaner_tags'>cleaner_tags</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_blank_all_tags'>blank_all_tags</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-All= </span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-IPTC:All= </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-XMP-madek:All= -IFD0:Artist= -IFD0:Copyright= -IFD0:Software= </span><span class='tstring_end'>&quot;</span></span> <span class='comment'># because we do want to remove IPTC tags, regardless
</span>    <span class='id identifier rubyid_tags'>tags</span> <span class='op'>=</span> <span class='id identifier rubyid_cleaner_tags'>cleaner_tags</span> <span class='op'>+</span> <span class='lparen'>(</span><span class='id identifier rubyid_blank_all_tags'>blank_all_tags</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_to_metadata_tags'>to_metadata_tags</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='const'>DOWNLOAD_STORAGE_DIR</span><span class='comma'>,</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_source_filename'>source_filename</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='comment'># TODO Tom ask: why is this called from here and not when the meta_key_definitions are updated? 
</span>    <span class='const'>Exiftool</span><span class='period'>.</span><span class='id identifier rubyid_generate_exiftool_config'>generate_exiftool_config</span> <span class='kw'>if</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_io_interface'>io_interface</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_definitions'>meta_key_definitions</span><span class='period'>.</span><span class='id identifier rubyid_maximum'>maximum</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updated_at</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&gt;</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_stat'>stat</span><span class='lparen'>(</span><span class='const'>EXIFTOOL_CONFIG</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_mtime'>mtime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>

    <span class='id identifier rubyid_resout'>resout</span> <span class='op'>=</span> <span class='backtick'>`</span><span class='embexpr_beg'>#{</span><span class='const'>EXIFTOOL_PATH</span><span class='rbrace'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tags'>tags</span><span class='rbrace'>}</span><span class='tstring_content'> &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>`</span></span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_rm'>rm</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>_original</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_resout'>resout</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1 image files updated</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='comment'># Exiftool backs up the original before editing. We don't need the backup.
</span>    <span class='kw'>return</span> <span class='id identifier rubyid_path'>path</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>rescue</span> 
    <span class='comment'># &quot;No such file or directory&quot; ?
</span>    <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>copy failed with </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="users_permitted_to_act-instance_method">
  
    - (<tt>Object</tt>) <strong>users_permitted_to_act</strong>(action) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/media_resource.rb', line 477</span>

<span class='kw'>def</span> <span class='id identifier rubyid_users_permitted_to_act'>users_permitted_to_act</span><span class='lparen'>(</span><span class='id identifier rubyid_action'>action</span><span class='rparen'>)</span>
  <span class='comment'># do not optimize away this query as resource.user can be null
</span>  <span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users.id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:media_resources</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resources.id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user_ids_by_userpermission'>user_ids_by_userpermission</span><span class='op'>=</span> <span class='const'>Userpermission</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resource_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>userpermissions.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action'>action</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user_ids_dissallowed_by_userpermission'>user_ids_dissallowed_by_userpermission</span> <span class='op'>=</span> <span class='const'>Userpermission</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>user_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resource_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>userpermissions.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action'>action</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user_ids_by_grouppermission_but_not_dissallowed'>user_ids_by_grouppermission_but_not_dissallowed</span><span class='op'>=</span> <span class='const'>Grouppermission</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>groups_users.user_id as user_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:group</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INNER JOIN groups_users ON groups_users.group_id = groups.id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resource_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>grouppermissions.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action'>action</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> user_id NOT IN ( </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user_ids_dissallowed_by_userpermission'>user_ids_dissallowed_by_userpermission</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'> )</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user_ids_by_publicpermission'>user_ids_by_publicpermission</span><span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users.id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CROSS JOIN media_resources</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>media_resources.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_action'>action</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>

  <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> users.id IN (
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'>
      UNION
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user_ids_by_userpermission'>user_ids_by_userpermission</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'>
      UNION
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user_ids_by_grouppermission_but_not_dissallowed'>user_ids_by_grouppermission_but_not_dissallowed</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'>
      UNION
        </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user_ids_by_publicpermission'>user_ids_by_publicpermission</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rbrace'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Feb 28 17:17:06 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.5 (ruby-1.9.3).
</div>

  </body>
</html>