<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Resource
  
    &mdash; Documentation by YARD 0.7.4
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (R)</a> &raquo; 
    
    
    <span class="title">Resource</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: Resource
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
    <dt class="r1">Included in:</dt>
    <dd class="r1"><span class='object_link'><a href="Media/Set.html" title="MediaSet (class)">MediaSet</a></span>, <span class='object_link'><a href="MediaEntry.html" title="MediaEntry (class)">MediaEntry</a></span>, <span class='object_link'><a href="Snapshot.html" title="Snapshot (class)">Snapshot</a></span></dd>
    
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/models/resource.rb</dd>
  
</dl>
<div class="clear"></div>






  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#included-class_method" title="included (class method)">+ (Object) <strong>included</strong>(base) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_tms_doc-class_method" title="to_tms_doc (class method)">+ (Object) <strong>to_tms_doc</strong>(resources, context = MetaContext.tms) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#acl%3F-instance_method" title="#acl? (instance method)">- (Boolean) <strong>acl?</strong>(action, scope, subject = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
ACL.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#as_json-instance_method" title="#as_json (instance method)">- (Object) <strong>as_json</strong>(options = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#context_valid%3F-instance_method" title="#context_valid? (instance method)">- (Boolean) <strong>context_valid?</strong>(context = MetaContext.core) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#context_warnings-instance_method" title="#context_warnings (instance method)">- (Object) <strong>context_warnings</strong>(context = MetaContext.core) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#default_permission-instance_method" title="#default_permission (instance method)">- (Object) <strong>default_permission</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_exiftool_config-instance_method" title="#generate_exiftool_config (instance method)">- (Object) <strong>generate_exiftool_config</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
ad-hoc method that generates a new exiftool config file, when it is sensed
that there are new keys/key_defs that should be saved in a file using the
XMP-madek metadata namespace.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_basic_info-instance_method" title="#get_basic_info (instance method)">- (Object) <strong>get_basic_info</strong>(current_user, extended_keys = [], with_thumb = false) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
TODO merge to as_json NEW and experimental for batch processes.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#managers-instance_method" title="#managers (instance method)">- (Object) <strong>managers</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#media_type-instance_method" title="#media_type (instance method)">- (Object) <strong>media_type</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#meta_data_for_context-instance_method" title="#meta_data_for_context (instance method)">- (Object) <strong>meta_data_for_context</strong>(context = MetaContext.core, build_if_not_exists = true) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
TODO cache methods results.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reindex-instance_method" title="#reindex (instance method)">- (Object) <strong>reindex</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#title-instance_method" title="#title (instance method)">- (Object) <strong>title</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
scope :without_meta_data, :select => &#8220;media_entries.*&#8221;,.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#title_and_user-instance_method" title="#title_and_user (instance method)">- (Object) <strong>title_and_user</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_metadata_tags-instance_method" title="#to_metadata_tags (instance method)">- (Object) <strong>to_metadata_tags</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
returns the meta_data for a particular resource, so that it can written
into a media file that is to be exported.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_attributes_with_pre_validation-instance_method" title="#update_attributes_with_pre_validation (instance method)">- (Object) <strong>update_attributes_with_pre_validation</strong>(attributes, current_user = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#updated_resource_file-instance_method" title="#updated_resource_file (instance method)">- (Object) <strong>updated_resource_file</strong>(blank_all_tags = false, size = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Instance method to update a copy (referenced by path) of a media file with
the meta_data tags provided args: blank_all_tags = flag indicating whether
we clean all the tags from the file, or update the tags in the file
returns: the path and filename of the updated copy or nil (if the copy
failed).
</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="included-class_method">
  
    + (<tt>Object</tt>) <strong>included</strong>(base) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 5</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_included'>included</span><span class='lparen'>(</span><span class='id identifier rubyid_base'>base</span><span class='rparen'>)</span>

 <span class='comment'># TODO observe bulk changes and reindex once
</span>  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:meta_data</span><span class='comma'>,</span> <span class='symbol'>:as</span> <span class='op'>=&gt;</span> <span class='symbol'>:resource</span><span class='comma'>,</span> <span class='symbol'>:dependent</span> <span class='op'>=&gt;</span> <span class='symbol'>:destroy</span> <span class='kw'>do</span> <span class='comment'>#working here#7 :include =&gt; :meta_key
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_key_id'>key_id</span><span class='rparen'>)</span>
      <span class='comment'># unless ... and !!v.match(/\A[+-]?\d+\Z/) # TODO path to String#is_numeric? method
</span>      <span class='comment'>#TODO: handle the case when key_id is a MetaKey object
</span>      <span class='id identifier rubyid_key_id'>key_id</span> <span class='op'>=</span> <span class='const'>MetaKey</span><span class='period'>.</span><span class='id identifier rubyid_find_by_label'>find_by_label</span><span class='lparen'>(</span><span class='id identifier rubyid_key_id'>key_id</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='kw'>unless</span> <span class='id identifier rubyid_key_id'>key_id</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Fixnum</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_key_id'>key_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='comment'># OPTIMIZE prevent find if is_dynamic meta_key
</span>      <span class='id identifier rubyid_r'>r</span> <span class='op'>||=</span> <span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_key_id'>key_id</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_get_value_for'>get_value_for</span><span class='lparen'>(</span><span class='id identifier rubyid_key_id'>key_id</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_key_id'>key_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>end</span>

    <span class='comment'>#def with_labels
</span>    <span class='comment'>#  h = {}
</span>    <span class='comment'>#  all.each do |meta_datum|
</span>    <span class='comment'>#    next unless meta_datum.meta_key # FIXME inconsistency: there are meta_data referencing to not existing meta_key_ids [131, 135]
</span>    <span class='comment'>#    h[meta_datum.meta_key.label] = meta_datum.to_s
</span>    <span class='comment'>#  end
</span>    <span class='comment'>#  h
</span>    <span class='comment'>#end
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_concatenated'>concatenated</span>
      <span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_s</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>; </span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_accepts_nested_attributes_for'>accepts_nested_attributes_for</span> <span class='symbol'>:meta_data</span><span class='comma'>,</span> <span class='symbol'>:allow_destroy</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
                                             <span class='symbol'>:reject_if</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_attributes'>attributes</span><span class='op'>|</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>value</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>and</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_destroy</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>
                                             <span class='comment'># NOTE the check on _destroy should be automatic, check Rails &gt; 3.0.3
</span>
<span class='comment'>#temp#
</span><span class='comment'>#    # enforce meta_key uniqueness updating existing meta_datum
</span><span class='comment'>#    # also useful for bulk meta_data updates such as Copyright, Organizer forms,...
</span><span class='comment'>#    base.before_validation(:on =&gt; :update) do |record|
</span><span class='comment'>#      new_meta_data = record.meta_data.select{|md| md.new_record? }
</span><span class='comment'>#      new_meta_data.each do |new_md|
</span><span class='comment'>#        old_md = record.meta_data.detect{|md| !md.new_record? and md.meta_key_id == new_md.meta_key_id }
</span><span class='comment'>#        if old_md
</span><span class='comment'>#          old_md.value = new_md.value
</span><span class='comment'>#          record.meta_data.delete(new_md)
</span><span class='comment'>#        end
</span><span class='comment'>#      end
</span><span class='comment'>#    end
</span>
  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_has_many'>has_many</span>  <span class='symbol'>:permissions</span><span class='comma'>,</span> <span class='symbol'>:as</span> <span class='op'>=&gt;</span> <span class='symbol'>:resource</span><span class='comma'>,</span> <span class='symbol'>:dependent</span> <span class='op'>=&gt;</span> <span class='symbol'>:destroy</span>
  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_before_validation'>before_validation</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_permissions'>permissions</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_new_record?'>new_record?</span> <span class='kw'>and</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_subject'>subject</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_invalid?'>invalid?</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span> <span class='comment'>#2904# OPTIMIZE
</span>  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_after_create'>after_create</span> <span class='symbol'>:generate_permissions</span>

  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_has_many'>has_many</span>  <span class='symbol'>:edit_sessions</span><span class='comma'>,</span> <span class='symbol'>:as</span> <span class='op'>=&gt;</span> <span class='symbol'>:resource</span><span class='comma'>,</span> <span class='symbol'>:dependent</span> <span class='op'>=&gt;</span> <span class='symbol'>:destroy</span><span class='comma'>,</span> <span class='symbol'>:readonly</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_has_many'>has_many</span>  <span class='symbol'>:editors</span><span class='comma'>,</span> <span class='symbol'>:through</span> <span class='op'>=&gt;</span> <span class='symbol'>:edit_sessions</span><span class='comma'>,</span> <span class='symbol'>:source</span> <span class='op'>=&gt;</span> <span class='symbol'>:user</span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_latest'>latest</span>
      <span class='id identifier rubyid_first'>first</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_validates_presence_of'>validates_presence_of</span> <span class='symbol'>:user</span><span class='comma'>,</span> <span class='symbol'>:if</span> <span class='op'>=&gt;</span> <span class='const'>Proc</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_record'>record</span><span class='op'>|</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:user_id</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_update_attributes_with_pre_validation'>update_attributes_with_pre_validation</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='comment'># we need to deep copy the attributes for batch edit (multiple resources)
</span>    <span class='id identifier rubyid_dup_attributes'>dup_attributes</span> <span class='op'>=</span> <span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='rparen'>)</span><span class='rparen'>)</span>

    <span class='comment'># To avoid overriding at batch update: remove from attribute hash if :keep_original_value and value is blank
</span>    <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:keep_original_value</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>

    <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_all?'>all?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>
        <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>

      <span class='comment'># find existing meta_datum, if it exists
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_md'>md</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:meta_key_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_md'>md</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
      <span class='kw'>end</span>

      <span class='comment'># get rid of meta_datum if value is blank
</span>      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
        <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:_destroy</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='comment'>#old# attr[:value] = &quot;.&quot; # NOTE bypass the validation
</span>      <span class='kw'>end</span>
    <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span>

    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_editors'>editors</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='comment'># OPTIMIZE group by user ??
</span>    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='comment'># OPTIMIZE touch
</span>    <span class='id identifier rubyid_update_attributes_without_pre_validation'>update_attributes_without_pre_validation</span><span class='lparen'>(</span><span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_alias_method_chain'>alias_method_chain</span> <span class='symbol'>:update_attributes</span><span class='comma'>,</span> <span class='symbol'>:pre_validation</span>

  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_has_one'>has_one</span> <span class='symbol'>:full_text</span><span class='comma'>,</span> <span class='symbol'>:as</span> <span class='op'>=&gt;</span> <span class='symbol'>:resource</span><span class='comma'>,</span> <span class='symbol'>:dependent</span> <span class='op'>=&gt;</span> <span class='symbol'>:destroy</span>
  <span class='id identifier rubyid_base'>base</span><span class='period'>.</span><span class='id identifier rubyid_after_save'>after_save</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_reindex'>reindex</span> <span class='rbrace'>}</span> <span class='comment'># OPTIMIZE
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="to_tms_doc-class_method">
  
    + (<tt>Object</tt>) <strong>to_tms_doc</strong>(resources, context = MetaContext.tms) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 247</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_to_tms_doc'>to_tms_doc</span><span class='lparen'>(</span><span class='id identifier rubyid_resources'>resources</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_tms'>tms</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_xml'>xml</span> <span class='op'>=</span> <span class='const'>Builder</span><span class='op'>::</span><span class='const'>XmlMarkup</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_xml'>xml</span><span class='period'>.</span><span class='id identifier rubyid_instruct!'>instruct!</span>
  <span class='id identifier rubyid_xml'>xml</span><span class='period'>.</span><span class='id identifier rubyid_madek'>madek</span><span class='lparen'>(</span><span class='symbol'>:version</span> <span class='op'>=&gt;</span> <span class='const'>RELEASE_VERSION</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_resources'>resources</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_resource'>resource</span><span class='op'>|</span>
      <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_to_tms'>to_tms</span><span class='lparen'>(</span><span class='id identifier rubyid_xml'>xml</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="acl?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>acl?</strong>(action, scope, subject = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
ACL
</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


330
331
332
333
334
335
336
337
338</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 330</span>

<span class='kw'>def</span> <span class='id identifier rubyid_acl?'>acl?</span><span class='lparen'>(</span><span class='id identifier rubyid_action'>action</span><span class='comma'>,</span> <span class='id identifier rubyid_scope'>scope</span><span class='comma'>,</span> <span class='id identifier rubyid_subject'>subject</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_scope'>scope</span>
    <span class='kw'>when</span> <span class='symbol'>:all</span>
      <span class='comment'># TODO ?? use :permissions association
</span>      <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_action'>action</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
    <span class='kw'>when</span> <span class='symbol'>:only</span>
      <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_resource_viewable_only_by_user?'>resource_viewable_only_by_user?</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_subject'>subject</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="as_json-instance_method">
  
    - (<tt>Object</tt>) <strong>as_json</strong>(options = {}) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 223</span>

<span class='kw'>def</span> <span class='id identifier rubyid_as_json'>as_json</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_with_thumb'>with_thumb</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:with_thumb</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_more_json'>more_json</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span>
    <span class='comment'>#TODO Dont do this behaviour on default
</span>    <span class='id identifier rubyid_flags'>flags</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:is_private</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_acl?'>acl?</span><span class='lparen'>(</span><span class='symbol'>:view</span><span class='comma'>,</span> <span class='symbol'>:only</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span><span class='comma'>,</span>
              <span class='symbol'>:is_public</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_acl?'>acl?</span><span class='lparen'>(</span><span class='symbol'>:view</span><span class='comma'>,</span> <span class='symbol'>:all</span><span class='rparen'>)</span><span class='comma'>,</span>
              <span class='symbol'>:is_editable</span> <span class='op'>=&gt;</span> <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='symbol'>:edit</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span><span class='comma'>,</span>
              <span class='symbol'>:is_manageable</span> <span class='op'>=&gt;</span> <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_authorized?'>authorized?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='symbol'>:manage</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_more_json'>more_json</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span> <span class='id identifier rubyid_flags'>flags</span>         
    <span class='id identifier rubyid_more_json'>more_json</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_basic_info'>get_basic_info</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_with_thumb'>with_thumb</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_default_options'>default_options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:only</span> <span class='op'>=&gt;</span> <span class='symbol'>:id</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_json'>json</span> <span class='op'>=</span> <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_default_options'>default_options</span><span class='period'>.</span><span class='id identifier rubyid_deep_merge'>deep_merge</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span><span class='rparen'>)</span>
  
  <span class='comment'># add relationships for a given parent
</span>  
  <span class='id identifier rubyid_json'>json</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_more_json'>more_json</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="context_valid?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>context_valid?</strong>(context = MetaContext.core) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


304
305
306</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 304</span>

<span class='kw'>def</span> <span class='id identifier rubyid_context_valid?'>context_valid?</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_core'>core</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_meta_data_for_context'>meta_data_for_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_all?'>all?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='op'>|</span> <span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_context_valid?'>context_valid?</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="context_warnings-instance_method">
  
    - (<tt>Object</tt>) <strong>context_warnings</strong>(context = MetaContext.core) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


289
290
291
292
293
294
295
296
297
298
299
300
301
302</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 289</span>

<span class='kw'>def</span> <span class='id identifier rubyid_context_warnings'>context_warnings</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_core'>core</span><span class='rparen'>)</span>
  <span class='ivar'>@context_warnings</span> <span class='op'>||=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>unless</span> <span class='ivar'>@context_warnings</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span>
    <span class='ivar'>@context_warnings</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_meta_data_for_context'>meta_data_for_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='op'>|</span>
      <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_context_warnings'>context_warnings</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_w'>w</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
        <span class='ivar'>@context_warnings</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_meta_key'>meta_key</span><span class='period'>.</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
        <span class='ivar'>@context_warnings</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_meta_datum'>meta_datum</span><span class='period'>.</span><span class='id identifier rubyid_meta_key'>meta_key</span><span class='period'>.</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_w'>w</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='ivar'>@context_warnings</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="default_permission-instance_method">
  
    - (<tt>Object</tt>) <strong>default_permission</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


98
99
100</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 98</span>

<span class='kw'>def</span> <span class='id identifier rubyid_default_permission'>default_permission</span>
  <span class='const'>Permission</span><span class='period'>.</span><span class='id identifier rubyid_resource_default'>resource_default</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="generate_exiftool_config-instance_method">
  
    - (<tt>Object</tt>) <strong>generate_exiftool_config</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
ad-hoc method that generates a new exiftool config file, when it is sensed
that there are new keys/key_defs that should be saved in a file using the
XMP-madek metadata namespace. TODO refactor the use of exiftool, so that
for each media file/entry it is only called once,  entrys&#8217; contents
cached, and obj/subj meta-data extracted as necessary
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


165
166
167
168
169
170
171
172
173
174
175
176
177</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 165</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_exiftool_config'>generate_exiftool_config</span>
  <span class='id identifier rubyid_exiftool_keys'>exiftool_keys</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_io_interface'>io_interface</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_definitions'>meta_key_definitions</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_key_map'>key_map</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='rbrace'>}</span><span class='tstring_content'> =&gt; {</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_key_map_type'>key_map_type</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Array</span><span class='tstring_end'>&quot;</span></span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> List =&gt; 'Bag'</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='kw'>nil</span><span class='rbrace'>}</span><span class='tstring_content'> },</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  
  <span class='id identifier rubyid_skels'>skels</span> <span class='op'>=</span> <span class='const'>Dir</span><span class='period'>.</span><span class='id identifier rubyid_glob'>glob</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>METADATA_CONFIG_DIR</span><span class='rbrace'>}</span><span class='tstring_content'>/ExifTool_config.skeleton.*</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  
  <span class='id identifier rubyid_exif_conf'>exif_conf</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='const'>EXIFTOOL_CONFIG</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>w</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exif_conf'>exif_conf</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_skels'>skels</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exiftool_keys'>exiftool_keys</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
    <span class='id identifier rubyid_exif_conf'>exif_conf</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\t</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_k'>k</span><span class='rbrace'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_exif_conf'>exif_conf</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_skels'>skels</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exif_conf'>exif_conf</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_basic_info-instance_method">
  
    - (<tt>Object</tt>) <strong>get_basic_info</strong>(current_user, extended_keys = [], with_thumb = false) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
TODO merge to as_json NEW and experimental for batch processes
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 181</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_basic_info'>get_basic_info</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='id identifier rubyid_extended_keys'>extended_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_with_thumb'>with_thumb</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_core_keys'>core_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>author</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_core_info'>core_info</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  
  <span class='lparen'>(</span><span class='id identifier rubyid_core_keys'>core_keys</span> <span class='op'>+</span> <span class='id identifier rubyid_extended_keys'>extended_keys</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span>
    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get_value_for'>get_value_for</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_with_thumb'>with_thumb</span>
    <span class='id identifier rubyid_mf'>mf</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Media</span><span class='op'>::</span><span class='const'>Set</span><span class='rparen'>)</span>
      <span class='const'>MediaResource</span><span class='period'>.</span><span class='id identifier rubyid_accessible_by_user'>accessible_by_user</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_media_entries'>media_entries</span><span class='period'>.</span><span class='id identifier rubyid_by_media_set'>by_media_set</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:media_file</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_media_file'>media_file</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>thumb_base64</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_mf'>mf</span><span class='period'>.</span><span class='id identifier rubyid_thumb_base64'>thumb_base64</span><span class='lparen'>(</span><span class='symbol'>:small_125</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_mf'>mf</span>
  <span class='kw'>else</span>
    <span class='comment'>#1+n http-requests#
</span>    <span class='id identifier rubyid_core_info'>core_info</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>thumb_base64</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/media_entries/%d/image?size=small_125</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_core_info'>core_info</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="managers-instance_method">
  
    - (<tt>Object</tt>) <strong>managers</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


340
341
342
343
344
345</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 340</span>

<span class='kw'>def</span> <span class='id identifier rubyid_managers'>managers</span>
  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='const'>Permission</span><span class='op'>::</span><span class='const'>ACTIONS</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='symbol'>:manage</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id identifier rubyid_i'>i</span>
  <span class='id identifier rubyid_j'>j</span> <span class='op'>=</span> <span class='int'>2</span> <span class='op'>**</span> <span class='id identifier rubyid_i'>i</span>
  <span class='id identifier rubyid_permissions'>permissions</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>SQLHelper</span><span class='period'>.</span><span class='id identifier rubyid_bitwise_is'>bitwise_is</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>action_bits</span><span class='tstring_end'>'</span></span><span class='comma'>,</span><span class='id identifier rubyid_j'>j</span><span class='rbrace'>}</span><span class='tstring_content'> AND </span><span class='embexpr_beg'>#{</span><span class='const'>SQLHelper</span><span class='period'>.</span><span class='id identifier rubyid_bitwise_is'>bitwise_is</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>action_mask</span><span class='tstring_end'>'</span></span><span class='comma'>,</span><span class='id identifier rubyid_j'>j</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:subject</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="media_type-instance_method">
  
    - (<tt>Object</tt>) <strong>media_type</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 310</span>

<span class='kw'>def</span> <span class='id identifier rubyid_media_type'>media_type</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:media_file</span><span class='rparen'>)</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_content_type'>content_type</span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>video</span><span class='regexp_end'>/</span></span> <span class='kw'>then</span> 
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Video</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>audio</span><span class='regexp_end'>/</span></span> <span class='kw'>then</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Audio</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>image</span><span class='regexp_end'>/</span></span> <span class='kw'>then</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Image</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span> 
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Doc</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span> 
  <span class='kw'>else</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_type'>type</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>Media::</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>    
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="meta_data_for_context-instance_method">
  
    - (<tt>Object</tt>) <strong>meta_data_for_context</strong>(context = MetaContext.core, build_if_not_exists = true) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
TODO cache methods results
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 271</span>

<span class='kw'>def</span> <span class='id identifier rubyid_meta_data_for_context'>meta_data_for_context</span><span class='lparen'>(</span><span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_core'>core</span><span class='comma'>,</span> <span class='id identifier rubyid_build_if_not_exists'>build_if_not_exists</span> <span class='op'>=</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='ivar'>@meta_data_for_context</span> <span class='op'>||=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='comment'># OPTIMIZE cache for build_if_not_exists
</span>  <span class='comment'>#unless @meta_data_for_context[context.id]
</span>    <span class='ivar'>@meta_data_for_context</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

    <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_meta_keys'>meta_keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span>
      <span class='id identifier rubyid_md'>md</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_scoped_by_resource_type_and_resource_id'>scoped_by_resource_type_and_resource_id</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_base_class'>base_class</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>  <span class='comment'># OPTIMIZE eager loading
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_md'>md</span>
        <span class='ivar'>@meta_data_for_context</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_md'>md</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_build_if_not_exists'>build_if_not_exists</span> <span class='kw'>or</span> <span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_is_dynamic?'>is_dynamic?</span>
        <span class='ivar'>@meta_data_for_context</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='symbol'>:meta_key</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_context'>context</span>
  <span class='comment'>#end
</span>  <span class='kw'>return</span> <span class='ivar'>@meta_data_for_context</span><span class='lbracket'>[</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="reindex-instance_method">
  
    - (<tt>Object</tt>) <strong>reindex</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


259
260
261
262
263
264
265
266</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 259</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reindex'>reindex</span>
  <span class='id identifier rubyid_ft'>ft</span> <span class='op'>=</span> <span class='id identifier rubyid_full_text'>full_text</span> <span class='op'>||</span> <span class='id identifier rubyid_build_full_text'>build_full_text</span>
  <span class='id identifier rubyid_new_text'>new_text</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_concatenated'>concatenated</span>
  <span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_method'>method</span><span class='op'>|</span>
    <span class='id identifier rubyid_new_text'>new_text</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_method'>method</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='id identifier rubyid_method'>method</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_ft'>ft</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_new_text'>new_text</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="title-instance_method">
  
    - (<tt>Object</tt>) <strong>title</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
scope :without_meta_data, :select => &#8220;media_entries.*&#8221;,
</p>
<pre class="code">
                                 <span class='comment'>#:joins =&gt; &quot;LEFT JOIN items ON items.model_id = models.id&quot;,
</span>                                 <span class='comment'>#:conditions =&gt; ['items.model_id IS NULL']</span></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


209
210
211
212
213</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 209</span>

<span class='kw'>def</span> <span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get_value_for'>get_value_for</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Ohne Titel</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_t'>t</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="title_and_user-instance_method">
  
    - (<tt>Object</tt>) <strong>title_and_user</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


215
216
217
218
219</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 215</span>

<span class='kw'>def</span> <span class='id identifier rubyid_title_and_user'>title_and_user</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[Projekt] </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Media</span><span class='op'>::</span><span class='const'>Project</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_title'>title</span><span class='rbrace'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='rbrace'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="to_metadata_tags-instance_method">
  
    - (<tt>Object</tt>) <strong>to_metadata_tags</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
returns the meta_data for a particular resource, so that it can written
into a media file that is to be exported. NB: this is exiftool specific at
present, but can be refactored to take account of other tools if necessary.
NB: In this case the &#8216;export&#8217; in
&#8216;get_data_for_export&#8217; also means &#8216;download&#8217; 
</p>
<pre class="code">
    (since we write meta-data to the file anyway regardless of if we do a download or an export)</pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 106</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_metadata_tags'>to_metadata_tags</span>
  <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_io_interface'>io_interface</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_definitions'>meta_key_definitions</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_definition'>definition</span><span class='op'>|</span>
    <span class='comment'># OPTIMIZE
</span>    <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_definition'>definition</span><span class='period'>.</span><span class='id identifier rubyid_meta_key'>meta_key</span><span class='period'>.</span><span class='id identifier rubyid_object_type'>object_type</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Meta::Date</span><span class='tstring_end'>&quot;</span></span>
              <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_definition'>definition</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_id'>meta_key_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
            <span class='kw'>else</span>
              <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_definition'>definition</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_id'>meta_key_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_deserialized_value'>deserialized_value</span>
            <span class='kw'>end</span>
    
    <span class='id identifier rubyid_definition'>definition</span><span class='period'>.</span><span class='id identifier rubyid_key_map'>key_map</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_km'>km</span><span class='op'>|</span>
      <span class='id identifier rubyid_km'>km</span><span class='period'>.</span><span class='id identifier rubyid_strip!'>strip!</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_definition'>definition</span><span class='period'>.</span><span class='id identifier rubyid_key_map_type'>key_map_type</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Array</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_vo'>vo</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_km'>km</span><span class='rbrace'>}</span><span class='tstring_content'>= </span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_vo'>vo</span> <span class='op'>+=</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_km'>km</span><span class='rbrace'>}</span><span class='tstring_content'>='</span><span class='embexpr_beg'>#{</span><span class='lparen'>(</span><span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:strip</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span> <span class='op'>:</span> <span class='id identifier rubyid_m'>m</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
          <span class='id identifier rubyid_vo'>vo</span>
        <span class='kw'>else</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_km'>km</span><span class='rbrace'>}</span><span class='tstring_content'>='</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='rbrace'>}</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span>          
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="update_attributes_with_pre_validation-instance_method">
  
    - (<tt>Object</tt>) <strong>update_attributes_with_pre_validation</strong>(attributes, current_user = nil) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 64</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_attributes_with_pre_validation'>update_attributes_with_pre_validation</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># we need to deep copy the attributes for batch edit (multiple resources)
</span>  <span class='id identifier rubyid_dup_attributes'>dup_attributes</span> <span class='op'>=</span> <span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='const'>Marshal</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='rparen'>)</span><span class='rparen'>)</span>

  <span class='comment'># To avoid overriding at batch update: remove from attribute hash if :keep_original_value and value is blank
</span>  <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:keep_original_value</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_all?'>all?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>

    <span class='comment'># find existing meta_datum, if it exists
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_md'>md</span> <span class='op'>=</span> <span class='id identifier rubyid_meta_data'>meta_data</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:meta_key_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:meta_key_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_md'>md</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
    <span class='kw'>end</span>

    <span class='comment'># get rid of meta_datum if value is blank
</span>    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>and</span> <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_attr'>attr</span><span class='lbracket'>[</span><span class='symbol'>:_destroy</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='comment'>#old# attr[:value] = &quot;.&quot; # NOTE bypass the validation
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='lbracket'>[</span><span class='symbol'>:meta_data_attributes</span><span class='rbracket'>]</span>

  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_editors'>editors</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='comment'># OPTIMIZE group by user ??
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='comment'># OPTIMIZE touch
</span>  <span class='id identifier rubyid_update_attributes_without_pre_validation'>update_attributes_without_pre_validation</span><span class='lparen'>(</span><span class='id identifier rubyid_dup_attributes'>dup_attributes</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="updated_resource_file-instance_method">
  
    - (<tt>Object</tt>) <strong>updated_resource_file</strong>(blank_all_tags = false, size = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Instance method to update a copy (referenced by path) of a media file with
the meta_data tags provided args: blank_all_tags = flag indicating whether
we clean all the tags from the file, or update the tags in the file
returns: the path and filename of the updated copy or nil (if the copy
failed)
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/resource.rb', line 133</span>

<span class='kw'>def</span> <span class='id identifier rubyid_updated_resource_file'>updated_resource_file</span><span class='lparen'>(</span><span class='id identifier rubyid_blank_all_tags'>blank_all_tags</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_source_filename'>source_filename</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_size'>size</span>
      <span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_get_preview'>get_preview</span><span class='lparen'>(</span><span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_full_path'>full_path</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_media_file'>media_file</span><span class='period'>.</span><span class='id identifier rubyid_file_storage_location'>file_storage_location</span>
    <span class='kw'>end</span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_cp'>cp</span><span class='lparen'>(</span> <span class='id identifier rubyid_source_filename'>source_filename</span><span class='comma'>,</span> <span class='const'>DOWNLOAD_STORAGE_DIR</span> <span class='rparen'>)</span>
    <span class='comment'># remember we want to handle the following:
</span>    <span class='comment'># include all madek tags in file
</span>    <span class='comment'># remove all (ok, as many as we can) tags from the file.
</span>    <span class='id identifier rubyid_cleaner_tags'>cleaner_tags</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_blank_all_tags'>blank_all_tags</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-All= </span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-IPTC:All= </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-XMP-madek:All= -IFD0:Artist= -IFD0:Copyright= -IFD0:Software= </span><span class='tstring_end'>&quot;</span></span> <span class='comment'># because we do want to remove IPTC tags, regardless
</span>    <span class='id identifier rubyid_tags'>tags</span> <span class='op'>=</span> <span class='id identifier rubyid_cleaner_tags'>cleaner_tags</span> <span class='op'>+</span> <span class='lparen'>(</span><span class='id identifier rubyid_blank_all_tags'>blank_all_tags</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_to_metadata_tags'>to_metadata_tags</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='const'>DOWNLOAD_STORAGE_DIR</span><span class='comma'>,</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_source_filename'>source_filename</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='comment'># TODO - robustification
</span>    <span class='id identifier rubyid_generate_exiftool_config'>generate_exiftool_config</span> <span class='kw'>if</span> <span class='const'>MetaContext</span><span class='period'>.</span><span class='id identifier rubyid_io_interface'>io_interface</span><span class='period'>.</span><span class='id identifier rubyid_meta_key_definitions'>meta_key_definitions</span><span class='period'>.</span><span class='id identifier rubyid_maximum'>maximum</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updated_at</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&gt;</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_stat'>stat</span><span class='lparen'>(</span><span class='const'>EXIFTOOL_CONFIG</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_mtime'>mtime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>

    <span class='id identifier rubyid_resout'>resout</span> <span class='op'>=</span> <span class='backtick'>`</span><span class='embexpr_beg'>#{</span><span class='const'>EXIFTOOL_PATH</span><span class='rbrace'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tags'>tags</span><span class='rbrace'>}</span><span class='tstring_content'> &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>`</span></span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_rm'>rm</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>_original</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_resout'>resout</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1 image files updated</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='comment'># Exiftool backs up the original before editing. We don't need the backup.
</span>    <span class='kw'>return</span> <span class='id identifier rubyid_path'>path</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>rescue</span> 
    <span class='comment'># &quot;No such file or directory&quot; ?
</span>    <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MediaFile#update_file_metadata, copy failed with </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu Dec 22 13:34:26 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.4 (ruby-1.9.2).
</div>

  </body>
</html>
