<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: MediaEntry</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">MediaEntry</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/media_entry_rb.html">
                app/models/media_entry.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                ActiveRecord::Base
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h1><a href="MediaEntry.html">MediaEntry</a></h1>
<pre>
 This class could just as easily also be known as MediaObject..
 and one day might become so.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000026">&lt;=&gt;</a>&nbsp;&nbsp;
      <a href="#M000032">album_ids</a>&nbsp;&nbsp;
      <a href="#M000030">class_crc</a>&nbsp;&nbsp;
      <a href="#M000024">context_valid?</a>&nbsp;&nbsp;
      <a href="#M000023">context_warnings</a>&nbsp;&nbsp;
      <a href="#M000020">default_actions</a>&nbsp;&nbsp;
      <a href="#M000021">default_permission_create</a>&nbsp;&nbsp;
      <a href="#M000035">exiftool_subjective</a>&nbsp;&nbsp;
      <a href="#M000034">extract_subjective_metadata</a>&nbsp;&nbsp;
      <a href="#M000018">get</a>&nbsp;&nbsp;
      <a href="#M000022">meta_data_for_context</a>&nbsp;&nbsp;
      <a href="#M000029">sphinx_internal_id</a>&nbsp;&nbsp;
      <a href="#M000033">to_export_including_metadata_sources</a>&nbsp;&nbsp;
      <a href="#M000025">to_s</a>&nbsp;&nbsp;
      <a href="#M000028">to_sphinx_doc</a>&nbsp;&nbsp;
      <a href="#M000027">to_sphinxpipe</a>&nbsp;&nbsp;
      <a href="#M000031">user_id_facet</a>&nbsp;&nbsp;
      <a href="#M000019">with_labels</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000027" class="method-detail">
        <a name="M000027"></a>

        <div class="method-heading">
          <a href="#M000027" class="method-signature">
          <span class="method-name">to_sphinxpipe</span><span class="method-args">(delta = 0)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000027-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000027-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 117</span>
117:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">to_sphinxpipe</span>(<span class="ruby-identifier">delta</span> = <span class="ruby-value">0</span>)
118:     
119:     <span class="ruby-identifier">update_all</span>(<span class="ruby-identifier">:delta</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delta</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
120:     
121:     <span class="ruby-identifier">docset</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">root</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;sphinx:docset&quot;</span>)
122:     <span class="ruby-identifier">docset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sphinx_schema</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;sphinx:schema&quot;</span>)
123:     <span class="ruby-constant">MetaKey</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
124:       <span class="ruby-identifier">sphinx_schema</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sphinx_field</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'sphinx:field'</span>)
125:       <span class="ruby-identifier">sphinx_field</span>[<span class="ruby-value str">'name'</span>] = <span class="ruby-identifier">key</span>.<span class="ruby-identifier">label</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\s/</span>, <span class="ruby-value str">'_'</span>)
126:     <span class="ruby-keyword kw">end</span>
127:     
128:     [<span class="ruby-value str">'user'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
129:       <span class="ruby-identifier">sphinx_schema</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sphinx_field</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'sphinx:field'</span>)
130:       <span class="ruby-identifier">sphinx_field</span>[<span class="ruby-value str">'name'</span>] = <span class="ruby-identifier">field</span>
131:     <span class="ruby-keyword kw">end</span>
132:     
133:     [[<span class="ruby-value str">'sphinx_internal_id'</span>, <span class="ruby-value str">'int'</span>], [<span class="ruby-value str">'class_crc'</span>, <span class="ruby-value str">'int'</span>], [<span class="ruby-value str">'sphinx_deleted'</span>, <span class="ruby-value str">'int'</span>, <span class="ruby-value str">'0'</span>], <span class="ruby-comment cmt"># required by thinking sphinx</span>
134:      [<span class="ruby-value str">'user_id'</span>, <span class="ruby-value str">'int'</span>], [<span class="ruby-value str">'album_ids'</span>, <span class="ruby-value str">'multi'</span>], [<span class="ruby-value str">'media_file_id'</span>, <span class="ruby-value str">'int'</span>], <span class="ruby-comment cmt"># association attributes</span>
135:      [<span class="ruby-value str">'is_public'</span>, <span class="ruby-value str">'int'</span>, <span class="ruby-value str">'0'</span>], <span class="ruby-comment cmt"># attributes</span>
136:      [<span class="ruby-value str">'user_id_facet'</span>, <span class="ruby-value str">'int'</span>], <span class="ruby-comment cmt"># facets</span>
137:      [<span class="ruby-value str">'subject_sort'</span>, <span class="ruby-value str">'str2ordinal'</span>, <span class="ruby-value str">''</span>], [<span class="ruby-value str">'creator_sort'</span>, <span class="ruby-value str">'str2ordinal'</span>, <span class="ruby-value str">''</span>], [<span class="ruby-value str">'created_at'</span>, <span class="ruby-value str">'timestamp'</span>] <span class="ruby-comment cmt"># sorting attributes</span>
138:      ].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attr</span><span class="ruby-operator">|</span>
139:       <span class="ruby-identifier">sphinx_schema</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sphinx_field</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'sphinx:attr'</span>)
140:       <span class="ruby-identifier">sphinx_field</span>[<span class="ruby-value str">'name'</span>] = <span class="ruby-identifier">attr</span>[<span class="ruby-value">0</span>]
141:       <span class="ruby-identifier">sphinx_field</span>[<span class="ruby-value str">'type'</span>] = <span class="ruby-identifier">attr</span>[<span class="ruby-value">1</span>]
142:       <span class="ruby-identifier">sphinx_field</span>[<span class="ruby-value str">'default'</span>] = <span class="ruby-identifier">attr</span>[<span class="ruby-value">2</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">attr</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
143:     <span class="ruby-keyword kw">end</span>
144: 
145:     <span class="ruby-identifier">media_entries</span> = <span class="ruby-identifier">all</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:delta</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">delta</span>})
146:     <span class="ruby-identifier">media_entries</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">docset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">to_sphinx_doc</span> }
147: 
148:     <span class="ruby-identifier">puts</span> <span class="ruby-node">%(&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n#{docset})</span>
149:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000026" class="method-detail">
        <a name="M000026"></a>

        <div class="method-heading">
          <a href="#M000026" class="method-signature">
          <span class="method-name">&lt;=&gt;</span><span class="method-args">(other)</span>
          </a>
        </div>
      
        <div class="method-description">
          <pre>
 compares two objects in order to sort them
</pre>
<p>
TODO required by dot
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000026-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000026-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 101</span>
101:   <span class="ruby-keyword kw">def</span> <span class="ruby-operator">&lt;=&gt;</span>(<span class="ruby-identifier">other</span>)
102:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">created_at</span>
103:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000032" class="method-detail">
        <a name="M000032"></a>

        <div class="method-heading">
          <a href="#M000032" class="method-signature">
          <span class="method-name">album_ids</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000032-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000032-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 197</span>
197:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">album_ids</span>
198:     <span class="ruby-identifier">albums</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:id</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
199:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000030" class="method-detail">
        <a name="M000030"></a>

        <div class="method-heading">
          <a href="#M000030" class="method-signature">
          <span class="method-name">class_crc</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000030-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000030-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 189</span>
189:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">class_crc</span>
190:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_crc32</span>.<span class="ruby-identifier">to_s</span>
191:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000024" class="method-detail">
        <a name="M000024"></a>

        <div class="method-heading">
          <a href="#M000024" class="method-signature">
          <span class="method-name">context_valid?</span><span class="method-args">(label = &quot;MAdeK Core&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000024-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000024-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 88</span>
88:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">context_valid?</span>(<span class="ruby-identifier">label</span> = <span class="ruby-value str">&quot;MAdeK Core&quot;</span>)
89:     <span class="ruby-identifier">meta_data_for_context</span>(<span class="ruby-identifier">label</span>).<span class="ruby-identifier">all?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">meta_datum</span><span class="ruby-operator">|</span> <span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">context_valid?</span>(<span class="ruby-identifier">label</span>) }
90:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000023" class="method-detail">
        <a name="M000023"></a>

        <div class="method-heading">
          <a href="#M000023" class="method-signature">
          <span class="method-name">context_warnings</span><span class="method-args">(label = &quot;MAdeK Core&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000023-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000023-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 76</span>
76:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">context_warnings</span>(<span class="ruby-identifier">label</span> = <span class="ruby-value str">&quot;MAdeK Core&quot;</span>)
77:     <span class="ruby-ivar">@context_warnings</span> <span class="ruby-operator">||=</span> {}
78:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@context_warnings</span>[<span class="ruby-identifier">label</span>]
79:       <span class="ruby-ivar">@context_warnings</span>[<span class="ruby-identifier">label</span>] = {}
80:       <span class="ruby-identifier">meta_data_for_context</span>(<span class="ruby-identifier">label</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">meta_datum</span><span class="ruby-operator">|</span>
81:         <span class="ruby-ivar">@context_warnings</span>[<span class="ruby-identifier">label</span>][<span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">meta_key</span>.<span class="ruby-identifier">label</span>] <span class="ruby-operator">||=</span> []
82:         <span class="ruby-ivar">@context_warnings</span>[<span class="ruby-identifier">label</span>][<span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">meta_key</span>.<span class="ruby-identifier">label</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">context_warnings</span>(<span class="ruby-identifier">label</span>)
83:       <span class="ruby-keyword kw">end</span>
84:     <span class="ruby-keyword kw">end</span>
85:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@context_warnings</span>[<span class="ruby-identifier">label</span>]
86:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">default_actions</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 47</span>
47:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">default_actions</span>
48:     <span class="ruby-constant">Permission</span>.<span class="ruby-identifier">default_actions_for</span>(<span class="ruby-keyword kw">self</span>)
49:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">default_permission_create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 51</span>
51:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">default_permission_create</span>
52:     <span class="ruby-identifier">permissions</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>)
53:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000035" class="method-detail">
        <a name="M000035"></a>

        <div class="method-heading">
          <a href="#M000035" class="method-signature">
          <span class="method-name">exiftool_subjective</span><span class="method-args">(media, tags = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <h4>Depends on:</h4>
<pre>
 [external] exiftool meta-data manipulation perl library.
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000035-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000035-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 256</span>
256:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exiftool_subjective</span>(<span class="ruby-identifier">media</span>, <span class="ruby-identifier">tags</span> = <span class="ruby-keyword kw">nil</span>)
257:     <span class="ruby-identifier">result_set</span> = []
258:     <span class="ruby-identifier">parse_hash</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-node">`exiftool -s #{media} -a -u -G1 -D -j`</span>).<span class="ruby-identifier">first</span>
259:     <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag_group</span><span class="ruby-operator">|</span>
260:       <span class="ruby-identifier">result_set</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">parse_hash</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tag_group</span>)}.<span class="ruby-identifier">sort</span>
261:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;result set=#{result_set.inspect}&quot;</span>
262:     <span class="ruby-keyword kw">end</span>
263:     <span class="ruby-identifier">result_set</span>
264:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000034" class="method-detail">
        <a name="M000034"></a>

        <div class="method-heading">
          <a href="#M000034" class="method-signature">
          <span class="method-name">extract_subjective_metadata</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Handler for extracting some subjective meta-data from whatever file has
been handed to us
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000034-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000034-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 214</span>
214:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">extract_subjective_metadata</span>
215:      <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> [<span class="ruby-value str">&quot;image&quot;</span>, <span class="ruby-value str">&quot;audio&quot;</span>, <span class="ruby-value str">&quot;video&quot;</span>].<span class="ruby-identifier">any?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">media_file</span>.<span class="ruby-identifier">content_type</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">w</span> }
216: 
217:      <span class="ruby-keyword kw">case</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">media_file</span>.<span class="ruby-identifier">content_type</span>
218:        <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/image/</span> 
219:          <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">group_tags</span> = [<span class="ruby-value str">'XMP-dc'</span>, <span class="ruby-value str">'XMP-iptcCore'</span>, <span class="ruby-value str">'IPTC2'</span>]
220:        <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/video/</span> <span class="ruby-comment cmt"># exiftool has no idea about .mkv containers</span>
221:          <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">group_tags</span> = [<span class="ruby-value str">'QuickTime'</span>, <span class="ruby-value str">'Track'</span>, <span class="ruby-value str">'Composite'</span>, <span class="ruby-value str">'RIFF'</span>, <span class="ruby-value str">'BMP'</span>, <span class="ruby-value str">'Flash'</span>, <span class="ruby-value str">'M2TS'</span>, <span class="ruby-value str">'AC3'</span>, <span class="ruby-value str">'H264'</span> ] <span class="ruby-comment cmt"># OPTIMIZE - some of these may move to Objective Metadata</span>
222:        <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/audio/</span> 
223:          <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">group_tags</span> = [<span class="ruby-value str">'MPEG'</span>, <span class="ruby-value str">'ID3'</span>, <span class="ruby-value str">'Track'</span>, <span class="ruby-value str">'Composite'</span>, <span class="ruby-value str">'ASF'</span>, <span class="ruby-value str">'FLAC'</span> ] <span class="ruby-comment cmt"># OPTIMIZE - some of these may move to Objective Metadata</span>
224:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/application/</span>
225:          <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">group_tags</span> = [<span class="ruby-value str">'FlashPix'</span>, <span class="ruby-value str">'PDF'</span>, <span class="ruby-value str">'XMP-'</span>, <span class="ruby-value str">'PostScript'</span>, <span class="ruby-value str">'Photoshop'</span>, <span class="ruby-value str">'EXE'</span>, <span class="ruby-value str">'ZIP'</span> ] <span class="ruby-comment cmt"># OPTIMIZE - some of these may move to Objective Metadata</span>
226:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/text/</span>
227:          <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">group_tags</span> = [<span class="ruby-value str">'HTML'</span> ] <span class="ruby-comment cmt"># and inevitably more..</span>
228:      <span class="ruby-keyword kw">end</span>
229: 
230:      <span class="ruby-identifier">blob</span> = <span class="ruby-identifier">exiftool_subjective</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">media_file</span>.<span class="ruby-identifier">public_filename</span>, <span class="ruby-identifier">group_tags</span>)
231:       <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag_array_entry</span><span class="ruby-operator">|</span>
232:         <span class="ruby-identifier">tag_array_entry</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
233:           <span class="ruby-comment cmt"># catch people tags and find_or_create_by as appropriate</span>
234:           <span class="ruby-identifier">entry_name</span> = <span class="ruby-identifier">entry</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">':'</span>).<span class="ruby-identifier">last</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[_-]/</span>,<span class="ruby-value str">' '</span>)
235:           <span class="ruby-identifier">entry_value</span> = <span class="ruby-identifier">entry</span>[<span class="ruby-value">1</span>]
236:           <span class="ruby-identifier">is_person</span> = <span class="ruby-constant">MetaKey</span>.<span class="ruby-identifier">find_by_label_and_object_type</span>(<span class="ruby-identifier">entry_name</span>, <span class="ruby-value str">'Person'</span>) <span class="ruby-comment cmt"># TODO this is going to get messy..</span>
237:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_person</span>
238:             <span class="ruby-identifier">firstname</span>, <span class="ruby-identifier">lastname</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">entry_value</span>) <span class="ruby-comment cmt"># assuming we get a firstname lastname</span>
239:             <span class="ruby-identifier">entry_value</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find_or_create_by_firstname_and_lastname</span>(<span class="ruby-identifier">:firstname</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">firstname</span>.<span class="ruby-identifier">capitalize</span>, <span class="ruby-identifier">:lastname</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">lastname</span>.<span class="ruby-identifier">capitalize</span>)
240:           <span class="ruby-keyword kw">end</span>
241:           <span class="ruby-identifier">meta_data</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">:meta_key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">entry_name</span>, <span class="ruby-identifier">:value</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">entry_value</span> ) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">entry_value</span>.<span class="ruby-identifier">blank?</span>
242:         <span class="ruby-keyword kw">end</span>
243:       <span class="ruby-keyword kw">end</span>
244:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;subjective metadata built: #{meta_data.inspect}&quot;</span>
245:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;self.errors-#{self.errors.inspect}&quot;</span>  <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">valid?</span>
246: 
247:     <span class="ruby-identifier">save</span>
248:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000018" class="method-detail">
        <a name="M000018"></a>

        <div class="method-heading">
          <a href="#M000018" class="method-signature">
          <span class="method-name">get</span><span class="method-args">(key_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000018-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000018-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 15</span>
15:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get</span>(<span class="ruby-identifier">key_id</span>)
16:       <span class="ruby-comment cmt"># TODO detect all instead of first OR MetaDatum#named_scope</span>
17:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">key_id</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Fixnum</span>
18:         <span class="ruby-identifier">meta_datum</span> = <span class="ruby-identifier">first</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:meta_key_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key_id</span> })
19:       <span class="ruby-keyword kw">else</span>
20:         <span class="ruby-identifier">meta_datum</span> = <span class="ruby-identifier">first</span>(<span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:meta_key</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:meta_keys</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:label</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key_id</span>.<span class="ruby-identifier">downcase</span> }})
21:       <span class="ruby-keyword kw">end</span>
22:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">meta_datum</span>
23:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">value</span>
24:       <span class="ruby-keyword kw">else</span>
25:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
26:       <span class="ruby-keyword kw">end</span>
27:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000022" class="method-detail">
        <a name="M000022"></a>

        <div class="method-heading">
          <a href="#M000022" class="method-signature">
          <span class="method-name">meta_data_for_context</span><span class="method-args">(label = &quot;MAdeK Core&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
TODO cache methods results
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000022-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000022-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 58</span>
58:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">meta_data_for_context</span>(<span class="ruby-identifier">label</span> = <span class="ruby-value str">&quot;MAdeK Core&quot;</span>) <span class="ruby-comment cmt"># OPTIMIZE labels as :symbol ??</span>
59:     <span class="ruby-ivar">@meta_data_for_context</span> <span class="ruby-operator">||=</span> {}
60:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@meta_data_for_context</span>[<span class="ruby-identifier">label</span>]
61:       <span class="ruby-ivar">@meta_data_for_context</span>[<span class="ruby-identifier">label</span>] = []
62: 
63:       <span class="ruby-identifier">context</span> = <span class="ruby-constant">MetaContext</span>.<span class="ruby-identifier">find_by_label</span> <span class="ruby-identifier">label</span>
64:       <span class="ruby-identifier">context</span>.<span class="ruby-identifier">all_meta_keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
65:         <span class="ruby-identifier">md</span> = <span class="ruby-identifier">key</span>.<span class="ruby-identifier">meta_data</span>.<span class="ruby-identifier">find_by_media_entry_id</span>(<span class="ruby-keyword kw">self</span>)  <span class="ruby-comment cmt"># OPTIMIZE eager loading</span>
66:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">md</span>
67:           <span class="ruby-ivar">@meta_data_for_context</span>[<span class="ruby-identifier">label</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">md</span>
68:         <span class="ruby-keyword kw">else</span>
69:           <span class="ruby-ivar">@meta_data_for_context</span>[<span class="ruby-identifier">label</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">meta_data</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">:meta_key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key</span>)
70:         <span class="ruby-keyword kw">end</span>
71:       <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">context</span>
72:     <span class="ruby-keyword kw">end</span>
73:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@meta_data_for_context</span>[<span class="ruby-identifier">label</span>]
74:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000029" class="method-detail">
        <a name="M000029"></a>

        <div class="method-heading">
          <a href="#M000029" class="method-signature">
          <span class="method-name">sphinx_internal_id</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000029-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000029-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 185</span>
185:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sphinx_internal_id</span>
186:     <span class="ruby-identifier">id</span>
187:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000033" class="method-detail">
        <a name="M000033"></a>

        <div class="method-heading">
          <a href="#M000033" class="method-signature">
          <span class="method-name">to_export_including_metadata_sources</span><span class="method-args">(meta_data_sources = &quot;exif&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000033-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000033-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 201</span>
201:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_export_including_metadata_sources</span>(<span class="ruby-identifier">meta_data_sources</span> = <span class="ruby-value str">&quot;exif&quot;</span>)
202:     <span class="ruby-comment cmt">#TODO - output the requested metadata-source data for the related media file (e.g. for images - exif, iptc..) in the result set.</span>
203:     <span class="ruby-comment cmt">#NOTE - see metal/download.rb</span>
204:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000025" class="method-detail">
        <a name="M000025"></a>

        <div class="method-heading">
          <a href="#M000025" class="method-signature">
          <span class="method-name">to_s</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
OPTIMIZE
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000025-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000025-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 94</span>
94:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_s</span>
95:     <span class="ruby-node">&quot;#{meta_data.get(&quot;title&quot;)}&quot;</span>
96:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000028" class="method-detail">
        <a name="M000028"></a>

        <div class="method-heading">
          <a href="#M000028" class="method-signature">
          <span class="method-name">to_sphinx_doc</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000028-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000028-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 151</span>
151:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_sphinx_doc</span>
152:     <span class="ruby-identifier">sphinx_document</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'sphinx:document'</span>)
153:     <span class="ruby-identifier">sphinx_document</span>[<span class="ruby-value str">'id'</span>] = <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
154: 
155:     <span class="ruby-identifier">meta_data</span>.<span class="ruby-identifier">with_labels</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
156:       <span class="ruby-identifier">sphinx_document</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">key</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\s/</span>, <span class="ruby-value str">'_'</span>))
157:       <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span>
158:       <span class="ruby-keyword kw">if</span> [<span class="ruby-value str">'subject'</span>, <span class="ruby-value str">'creator'</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">key</span>)
159:         <span class="ruby-identifier">sphinx_document</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{key}_sort&quot;</span>)
160:         <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span>
161:       <span class="ruby-keyword kw">end</span>
162:     <span class="ruby-keyword kw">end</span>
163:     
164:     [<span class="ruby-value str">'sphinx_internal_id'</span>, <span class="ruby-value str">'class_crc'</span>,
165:      <span class="ruby-value str">'user_id'</span>, <span class="ruby-value str">'album_ids'</span>, <span class="ruby-value str">'media_file_id'</span>,
166:      <span class="ruby-value str">'user_id_facet'</span>,
167:      <span class="ruby-value str">'user'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attr</span><span class="ruby-operator">|</span>
168:       <span class="ruby-identifier">sphinx_document</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">attr</span>)
169:       <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">send</span>(<span class="ruby-identifier">attr</span>).<span class="ruby-identifier">to_s</span>
170:     <span class="ruby-keyword kw">end</span>
171: 
172:     [<span class="ruby-value str">'created_at'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attr</span><span class="ruby-operator">|</span>
173:       <span class="ruby-identifier">sphinx_document</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">attr</span>)
174:       <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">send</span>(<span class="ruby-identifier">attr</span>).<span class="ruby-identifier">to_i</span>
175:     <span class="ruby-keyword kw">end</span>
176: 
177:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_public</span>
178:       <span class="ruby-identifier">sphinx_document</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> = <span class="ruby-constant">XML</span><span class="ruby-operator">::</span><span class="ruby-constant">Node</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'is_public'</span>)
179:       <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;1&quot;</span>
180:     <span class="ruby-keyword kw">end</span>
181:     
182:     <span class="ruby-identifier">sphinx_document</span>
183:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000031" class="method-detail">
        <a name="M000031"></a>

        <div class="method-heading">
          <a href="#M000031" class="method-signature">
          <span class="method-name">user_id_facet</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000031-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000031-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 193</span>
193:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">user_id_facet</span>
194:     <span class="ruby-identifier">user_id</span>
195:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">with_labels</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/media_entry.rb, line 29</span>
29:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">with_labels</span>
30:       <span class="ruby-identifier">h</span> = {}
31:       <span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">meta_datum</span><span class="ruby-operator">|</span>
32:         <span class="ruby-identifier">h</span>[<span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">meta_key</span>.<span class="ruby-identifier">label</span>] = <span class="ruby-identifier">meta_datum</span>.<span class="ruby-identifier">value</span>
33:       <span class="ruby-keyword kw">end</span>
34:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">h</span>
35:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>