/
  .page_title_left
    %img{:src => "/assets/icons/icon_permission.png"}
    = _("Zugriffsberechtigungen editieren")
  .clear

- if @resources and  (not @resources.detect{ |r| r.is_a? MediaSet })
  - path = request.fullpath == "/upload/permissions" ? permissions_upload_path : update_multiple_media_entry_permissions_path(0) 
  = form_tag path, :method => :put do
    = hidden_field_tag :media_entry_ids, @resources.map(&:id).join(',')
    = render :partial => "permissions/table", :locals => {:display_download_action => true }
    %div{:class => "save_buttons"}   
      = link_to _("Abbrechen"), "javascript:history.back(1);"
      = submit_tag _("Speichern")

- elsif @resource
  - if @resource.is_a?(MediaEntry)
    = form_tag update_multiple_media_entry_permissions_path(0), :method => :put do
      = hidden_field_tag :media_entry_ids, @resource.id
      = render :partial => "permissions/table", :locals => {:display_download_action => true }
      %div{:class => "save_buttons"}   
        = link_to _("Abbrechen"), media_entry_path(@resource)
        = submit_tag _("Speichern")
  - elsif @resource.is_a?(MediaSet)
    = form_tag update_multiple_media_set_permissions_path(@resource), :method => :put do
      = render :partial => "permissions/table", :locals => {:display_download_action => false }
      %div{:class => "save_buttons"}   
        = link_to _("Abbrechen"), media_set_path(@resource)
        = submit_tag _("Speichern")

- else
  - raise "multiple media_entries or a single media_resource is missing"

%script{:type => "text/x-jquery-tmpl", :id => "new_permission"}
  %tr
    %td
      ${name}    
    %td{:class => "{{if (view == 'mixed')}}different_values{{/if}}"}
      %input{:name => "{{if (type == 'nil')}}subject[${type}][view]{{else}}subject[${type}][${id}][view]{{/if}}", :type => "hidden", :value => "false"}
      <input name="{{if (type == 'nil')}}subject[${type}][view]{{else}}subject[${type}][${id}][view]{{/if}}" type="checkbox" value="true" {{if view}}checked="checked"{{/if}}>
    %td{:class => "{{if (edit == 'mixed')}}different_values{{/if}}"}
      %input{:name => "{{if (type == 'nil')}}subject[${type}][edit]{{else}}subject[${type}][${id}][edit]{{/if}}", :type => "hidden", :value => "false"}
      <input name="{{if (type == 'nil')}}subject[${type}][edit]{{else}}subject[${type}][${id}][edit]{{/if}}" type="checkbox" value="true" {{if edit}}checked="checked"{{/if}}>
    - if @resources or (@resource and @resource.is_a?(MediaEntry))
      %td{:class => "{{if (download == 'mixed')}}different_values{{/if}}"}
        %input{:name => "{{if (type == 'nil')}}subject[${type}][download]{{else}}subject[${type}][${id}][download]{{/if}}", :type => "hidden", :value => "false"}
        <input name="{{if (type == 'nil')}}subject[${type}][download]{{else}}subject[${type}][${id}][download]{{/if}}" type="checkbox" value="true" {{if download}}checked="checked"{{/if}}>
    %td
      {{if manage}}
      %input{:type => :checkbox, :checked => :checked, :disabled => :disabled}
      {{/if}}
    %td
      {{if type != 'nil' && id != #{current_user.id} }}
      = link_to _("LÃ¶schen"), "#", :class => "delete", :msg => _("Sind Sie sicher?"), :"data-id" => "${id}", :"data-type" => "${type}"
      {{/if}}  

:javascript
  $(function() {
    var permissions = #{@permissions_json};

    if (permissions.User != undefined) $('#user_permissions').html($("#new_permission").tmpl(permissions.User)); 
    var selected_user_ids = (permissions.User != undefined) ? $.map(permissions.User, function(elem, i){ return parseInt(elem.id); }) : new Array();
    
    if (permissions.Group != undefined) $('#group_permissions').html($("#new_permission").tmpl(permissions.Group)); 
    var selected_group_ids = (permissions.Group != undefined) ? $.map(permissions.Group, function(elem, i){ return parseInt(elem.id); }) : new Array();

    $('#anyone_permissions').html($("#new_permission").tmpl(permissions.public));


    $("input#new_user").autocomplete({
      source: function(request, response){
        $.ajax({
    			url: '/users',
    			data: {query: request.term},
    			dataType: 'json',
    			type: "get",
    			success: function(data){
    			  var unselected_options = data.filter(function(elem) { 
    			    var i = selected_user_ids.indexOf(elem.id);
    			    if (i == -1) return elem;
    			  });
    			  unselected_options = $.map(unselected_options, function(elem) { return { id: elem.id, value: elem.name }; });
            response($.ui.autocomplete.filter(unselected_options, request.term));
    			}
    		});
      },
      minLength: 3,
      select: function(event, ui) {
        var data = {type: 'User', id: ui.item.id, name: ui.item.label, view: false, edit: false, download: false }
        $('#user_permissions').append($("#new_permission").tmpl(data)).effect('highlight');
        selected_user_ids.push(ui.item.id);
      }, 
      close: function(event, ui) {
        $(this).val("");
      }
    });
    
    $("input#new_group").autocomplete({
      source: function(request, response){
        $.ajax({
    			url: '/groups',
    			data: {query: request.term},
    			dataType: 'json',
    			type: "get",
    			success: function(data){
    			  var unselected_options = data.filter(function(elem) { 
    			    var i = selected_group_ids.indexOf(elem.id);
    			    if (i == -1) return elem;
    			  });
            unselected_options = $.map(unselected_options, function(elem) { return { id: elem.id, value: elem.name }; });
            response($.ui.autocomplete.filter(unselected_options, request.term));
    			}
    		});
      },
      minLength: 3,
      select: function(event, ui) {
        var data = {type: 'Group', id: ui.item.id, name: ui.item.label, view: false, edit: false, download: false }
        $('#group_permissions').append($("#new_permission").tmpl(data)).effect('highlight');
        selected_group_ids.push(ui.item.id);
      }, 
      close: function(event, ui) {
        $(this).val("");
      }
    });

    // TODO override jquery_ujs.js data-method and data-confirm
    $(".permissions a.delete[msg]").live('click', function(){
      var element = $(this);
      var message = element.attr('msg');
      if(confirm(message)){
        var id = element.data("id");
        var type_arr = (element.data("type") == "Group") ? selected_group_ids : selected_user_ids
        var i = type_arr.indexOf(id);
        type_arr.splice(i, 1);
        var to_remove = element.closest("tr");
        to_remove.fadeOut('slow', function() {
          to_remove.remove();
        });
      }
      return false;
    });
  });

